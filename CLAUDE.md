# CLAUDE.md

Guidance for Claude Code when working with this repository.

## Project Overview

**ANcpLua.NET.Sdk** is an opinionated MSBuild SDK providing better developer experience than plain Microsoft.NET.Sdk:

- Banned API enforcement (RS0030) + ANcpLua.Analyzers (AL0001-AL0014)
- Polyfills for modern .NET features on legacy TFMs
- Embedded source helpers (Throw.IfNull, SourceGen utilities)
- ASP.NET Core service defaults (OpenTelemetry, Health Checks, Resilience)

**Current Version:** 1.2.2

## CLI Commands (READ THIS FIRST)

### dotnet test

**This test project uses MTP (xunit.v3.mtp-v2), NOT VSTest.**

```bash
# ✅ MTP syntax (this repo)
dotnet test --project tests/ANcpLua.Sdk.Tests/ANcpLua.Sdk.Tests.csproj
dotnet test --project tests/ANcpLua.Sdk.Tests/ANcpLua.Sdk.Tests.csproj --treenode-filter "/**/SomeTest"
dotnet test --project tests/ANcpLua.Sdk.Tests/ANcpLua.Sdk.Tests.csproj --report-trx

# ❌ VSTest syntax (DOES NOT WORK with MTP)
dotnet test --filter "FullyQualifiedName~SomeTest"
dotnet test --logger "trx"

# ❌ Missing --project flag
dotnet test tests/ANcpLua.Sdk.Tests/
dotnet test tests/ANcpLua.Sdk.Tests/ANcpLua.Sdk.Tests.csproj
```

**MTP vs VSTest option mapping:**

| VSTest                                  | MTP                                         |
|-----------------------------------------|---------------------------------------------|
| `--filter "FullyQualifiedName~Foo"`     | `--treenode-filter "/**/Foo"`               |
| `--logger "trx"`                        | `--report-trx`                              |
| `--logger "console;verbosity=detailed"` | `--verbosity detailed`                      |
| `-v detailed`                           | N/A (MSBuild verbosity, not test verbosity) |

```

### Build & Pack

```bash
pwsh ./build.ps1 -Version 1.3.0    # Release
pwsh ./build.ps1 -Version 999.9.9  # Testing
```

### GitHub Actions Versions (Dec 2025)

```yaml
- uses: actions/checkout@v6
- uses: actions/setup-dotnet@v5
- uses: actions/upload-artifact@v4
```

### gh CLI

```bash
gh workflow run <workflow>.yml
gh run watch
gh run download <run-id> --name <artifact-name>
```

## Package Ecosystem

```
ANcpLua.Roslyn.Utilities (NuGet, netstandard2.0)
         │
         ├──► ANcpLua.Roslyn.Utilities.Testing (net10.0)
         │
         └──► ANcpLua.NET.Sdk (embeds source)
                    │
                    ├──► ANcpLua.NET.Sdk.Web
                    └──► ANcpLua.NET.Sdk.Test
```

| Package                    | Purpose                                      |
|----------------------------|----------------------------------------------|
| `ANcpLua.NET.Sdk`          | Base SDK for libraries, console, workers     |
| `ANcpLua.NET.Sdk.Web`      | Web SDK with auto-registered ServiceDefaults |
| `ANcpLua.NET.Sdk.Test`     | Test SDK with xUnit configuration            |
| `ANcpLua.Analyzers`        | Code analyzers (AL0001-AL0014)               |
| `ANcpLua.Roslyn.Utilities` | Single source for Roslyn utilities           |

## Directory Structure

```
src/
├── Sdk/ANcpLua.NET.Sdk/       # SDK entry points
├── common/
│   ├── Common.targets         # Main injection logic
│   ├── LegacySupport.targets  # Polyfill + SourceGen injection
│   ├── Tests.targets          # Test project configuration
│   └── Version.props          # Auto-generated by build.ps1
└── configuration/
    └── BannedSymbols.txt

eng/
├── ANcpSdk.AspNetCore.ServiceDefaults/
├── Extensions/
│   ├── SourceGen/             # Embedded Roslyn helpers
│   ├── Comparers/             # StringOrdinalComparer
│   └── FakeLogger/            # Test helpers
├── Shared/Throw/              # Guard clauses
└── LegacySupport/             # Polyfills

tests/ANcpLua.Sdk.Tests/
├── Helpers/                   # PackageFixture, ProjectBuilder, BuildResult
└── Infrastructure/            # TestInfrastructure, PolyfillTestCases
```

## Automation (Zero Manual Steps)

| Automation       | Trigger       | What Happens                |
|------------------|---------------|-----------------------------|
| Submodule sync   | `build.ps1`   | Auto-syncs Roslyn.Utilities |
| Source transform | `build.ps1`   | Regenerates embedded source |
| Dependabot       | Daily/Weekly  | Creates PRs for updates     |
| NuGet publish    | Tag push `v*` | Publishes to nuget.org      |

**build.ps1 does everything:** submodule sync, transform, clean, version props, pack.

## Test Infrastructure

### Test Classes (SdkTests.cs)

Tests run 3x due to inheritance:

- `Sdk100RootTests` → `SdkImportStyle.ProjectElement`
- `Sdk100InnerTests` → `SdkImportStyle.SdkElement`
- `Sdk100DirectoryBuildPropsTests` → `SdkImportStyle.SdkElementDirectoryBuildProps`

### Key Files

| File                    | Purpose                                         |
|-------------------------|-------------------------------------------------|
| `PackageFixture.cs`     | Assembly fixture, packs SDK before tests        |
| `ProjectBuilder.cs`     | Creates temp projects, runs dotnet commands     |
| `BuildResult.cs`        | Parses binlog, SARIF, checks MSBuild properties |
| `TestInfrastructure.cs` | Constants, polyfill definitions                 |

## Test Project vs MTP Detection

**Two separate concerns:**

### 1. IsTestProject (broad)

Triggers: Any test framework package (xunit, xunit.v3, NUnit, MSTest, TUnit)

Users must set `IsTestProject=true` explicitly in csproj.

### 2. UseMicrosoftTestingPlatform (strict)

**MTP signals:**

- `TUnit` package (always MTP)
- `xunit.v3.mtp-v1` / `xunit.v3.mtp-v2`
- `Microsoft.Testing.Extensions.*` packages
- `EnableNUnitRunner=true` / `EnableMSTestRunner=true`
- `UseMicrosoftTestingPlatform=true`

**NOT MTP (VSTest by default):**

- Plain `xunit.v3`
- `NUnit` alone
- `MSTest.TestFramework` alone
- `xunit` (v2)

### Injected Packages

| Condition       | Injected                                                       |
|-----------------|----------------------------------------------------------------|
| MTP             | CrashDump, HangDump, CodeCoverage, TrxReport, HotReload, Retry |
| VSTest          | Microsoft.NET.Test.Sdk                                         |
| GitHub + MTP    | GitHubActionsTestLogger 3.x                                    |
| GitHub + VSTest | GitHubActionsTestLogger 2.4.1                                  |

## MSBuild Properties

### Auto-Enabled

| Property                      | Description            |
|-------------------------------|------------------------|
| `InjectSharedThrow`           | Throw.IfNull() helpers |
| `IncludeDefaultBannedSymbols` | RS0030 banned symbols  |
| `BanNewtonsoftJsonSymbols`    | Ban Newtonsoft.Json    |

### Opt-In

| Property                      | Description                     |
|-------------------------------|---------------------------------|
| `InjectSourceGenHelpers`      | Roslyn utilities for generators |
| `InjectStringOrdinalComparer` | StringOrdinalComparer           |
| `InjectFakeLogger`            | FakeLoggerExtensions            |
| `InjectLockPolyfill`          | System.Threading.Lock           |
| `InjectTimeProviderPolyfill`  | System.TimeProvider             |

## SourceGen Helpers

Source generators can't reference NuGet at runtime — must embed as source.

**Submodule:** `eng/submodules/Roslyn.Utilities/`

**Transform:** `pwsh eng/scripts/Transform-RoslynUtilities.ps1`

| Original                             | Transformed                     |
|--------------------------------------|---------------------------------|
| `namespace ANcpLua.Roslyn.Utilities` | `namespace ANcpLua.SourceGen`   |
| `public static class`                | `internal static class`         |
| (none)                               | `#if ANCPLUA_SOURCEGEN_HELPERS` |

**Output:** `eng/.generated/SourceGen/` (gitignored)

## Critical Patterns

### Value Equality for Caching

```csharp
// ✅ Correct
IncrementalValuesProvider<EquatableArray<T>>

// ❌ Wrong - reference equality breaks caching
IncrementalValuesProvider<ImmutableArray<T>>
```

### Cache-Safe Diagnostics

```csharp
// ✅ Extract primitives
record struct LocationInfo(string Path, TextSpan Span, LinePositionSpan LineSpan);

// ❌ Never cache
Location, ISymbol, Compilation, SemanticModel, SyntaxNode
```

## Known Test Skips

| Test                                          | Platform               | Reason                                                        |
|-----------------------------------------------|------------------------|---------------------------------------------------------------|
| `CanOverrideLangVersionInDirectoryBuildProps` | All (SdkElement style) | MSBuild import order — covered by DirectoryBuildProps variant |