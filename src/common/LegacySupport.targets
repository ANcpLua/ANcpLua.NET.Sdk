<!--
  LegacySupport.targets - Polyfill and extension injection

  Injects shared source files into projects based on:
  1. The properties set in the project (InjectXxx)
  2. The target framework (only inject when needed)
-->
<Project>
  <!-- Enable dependencies for SharedThrow -->
  <PropertyGroup Condition="'$(InjectSharedThrow)' == 'true'">
    <InjectCallerAttributesOnLegacy>true</InjectCallerAttributesOnLegacy>
    <InjectNullabilityAttributesOnLegacy>true</InjectNullabilityAttributesOnLegacy>
  </PropertyGroup>

  <!-- ═══════════════════════════════════════════════════════════════════════
       TFM DETECTION HELPERS
       ═══════════════════════════════════════════════════════════════════════ -->
  <PropertyGroup>
    <!-- Detect if we need polyfills based on TFM -->
    <_NeedsNet5Polyfills>false</_NeedsNet5Polyfills>
    <_NeedsNet5Polyfills Condition="!$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'net5.0'))">true</_NeedsNet5Polyfills>

    <_NeedsNet6Polyfills>false</_NeedsNet6Polyfills>
    <_NeedsNet6Polyfills Condition="!$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'net6.0'))">true</_NeedsNet6Polyfills>

    <_NeedsNet7Polyfills>false</_NeedsNet7Polyfills>
    <_NeedsNet7Polyfills Condition="!$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'net7.0'))">true</_NeedsNet7Polyfills>

    <_NeedsNet8Polyfills>false</_NeedsNet8Polyfills>
    <_NeedsNet8Polyfills Condition="!$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'net8.0'))">true</_NeedsNet8Polyfills>

    <_NeedsNet9Polyfills>false</_NeedsNet9Polyfills>
    <_NeedsNet9Polyfills Condition="!$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'net9.0'))">true</_NeedsNet9Polyfills>

    <_NeedsNetCoreApp31Polyfills>false</_NeedsNetCoreApp31Polyfills>
    <_NeedsNetCoreApp31Polyfills Condition="!$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'netcoreapp3.1'))">true</_NeedsNetCoreApp31Polyfills>

    <!-- Shared folder path -->
    <_SharedSourcePath>$(MSBuildThisFileDirectory)shared\</_SharedSourcePath>
  </PropertyGroup>

  <Target Name="DebugLegacySupport" BeforeTargets="CoreCompile">
    <Message Importance="High" Text="LegacySupport: InjectANcpLuaLanguageFeaturesPolyfills = $(InjectANcpLuaLanguageFeaturesPolyfills)"/>
    <Message Importance="High" Text="LegacySupport: _NeedsNet5Polyfills = $(_NeedsNet5Polyfills)"/>
    <Message Importance="High" Text="LegacySupport: _SharedSourcePath = $(_SharedSourcePath)"/>
  </Target>

  <!-- ═══════════════════════════════════════════════════════════════════════
       POLYFILLS - BCL Types for Older TFMs
       ═══════════════════════════════════════════════════════════════════════ -->

  <!-- ─────────────────────────────────────────────────────────────────────────
       TRIM ATTRIBUTES (< net5.0)
       RequiresUnreferencedCodeAttribute, RequiresDynamicCodeAttribute,
       DynamicallyAccessedMembersAttribute, UnconditionalSuppressMessageAttribute
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="('$(InjectTrimAttributesOnLegacy)' == 'true' OR '$(InjectANcpLuaTrimAttributesPolyfills)' == 'true') AND '$(_NeedsNet5Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/TrimAttributes/*.cs" LinkBase="Shared/Polyfills/TrimAttributes" Visible="false"/>
  </ItemGroup>

  <!-- RequiresDynamicCodeAttribute came in net7.0 -->
  <ItemGroup Condition="('$(InjectTrimAttributesOnLegacy)' == 'true' OR '$(InjectANcpLuaTrimAttributesPolyfills)' == 'true') AND '$(_NeedsNet7Polyfills)' == 'true' AND '$(_NeedsNet5Polyfills)' != 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/TrimAttributes/RequiresDynamicCodeAttribute.cs" LinkBase="Shared/Polyfills/TrimAttributes" Visible="false"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       NULLABILITY ATTRIBUTES (< netcoreapp3.1)
       AllowNull, DisallowNull, MaybeNull, NotNull, DoesNotReturn, etc.
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="('$(InjectNullabilityAttributesOnLegacy)' == 'true' OR '$(InjectANcpLuaNullabilityPolyfills)' == 'true') AND '$(_NeedsNetCoreApp31Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/DiagnosticAttributes/NullableAttributes.cs" LinkBase="Shared/Polyfills/NullabilityAttributes" Visible="false"/>
  </ItemGroup>

  <!-- MemberNotNull/MemberNotNullWhen came in net5.0 (always include if enabled, has #if guards) -->
  <ItemGroup Condition="('$(InjectNullabilityAttributesOnLegacy)' == 'true' OR '$(InjectANcpLuaNullabilityPolyfills)' == 'true') AND '$(_NeedsNet5Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/NullabilityAttributes/MemberNotNullAttributes.cs" LinkBase="Shared/Polyfills/NullabilityAttributes" Visible="false"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       LANGUAGE FEATURES
       ───────────────────────────────────────────────────────────────────────── -->

  <!-- IsExternalInit (< net5.0) - enables records -->
  <ItemGroup Condition="('$(InjectIsExternalInitOnLegacy)' == 'true' OR '$(InjectANcpLuaLanguageFeaturesPolyfills)' == 'true') AND '$(_NeedsNet5Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/LanguageFeatures/IsExternalInit.cs" LinkBase="Shared/Polyfills/LanguageFeatures" Visible="false"/>
  </ItemGroup>

  <!-- RequiredMemberAttribute (< net7.0) - enables 'required' keyword -->
  <ItemGroup Condition="('$(InjectRequiredMemberOnLegacy)' == 'true' OR '$(InjectANcpLuaLanguageFeaturesPolyfills)' == 'true') AND '$(_NeedsNet7Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/LanguageFeatures/RequiredMemberAttribute.cs" LinkBase="Shared/Polyfills/LanguageFeatures" Visible="false"/>
  </ItemGroup>

  <!-- CompilerFeatureRequiredAttribute (< net7.0) - required for 'required' keyword -->
  <ItemGroup Condition="('$(InjectCompilerFeatureRequiredOnLegacy)' == 'true' OR '$(InjectANcpLuaLanguageFeaturesPolyfills)' == 'true') AND '$(_NeedsNet7Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/LanguageFeatures/CompilerFeatureRequiredAttribute.cs" LinkBase="Shared/Polyfills/LanguageFeatures" Visible="false"/>
  </ItemGroup>

  <!-- CallerArgumentExpressionAttribute (< net6.0) -->
  <ItemGroup Condition="('$(InjectCallerAttributesOnLegacy)' == 'true' OR '$(InjectANcpLuaLanguageFeaturesPolyfills)' == 'true') AND '$(_NeedsNet6Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/LanguageFeatures/CallerArgumentExpressionAttribute.cs" LinkBase="Shared/Polyfills/LanguageFeatures" Visible="false"/>
  </ItemGroup>

  <!-- Index and Range (< netcoreapp3.0 / netstandard2.1) - enables arr[^1], arr[1..3] -->
  <!-- These have #if guards: !NETCOREAPP3_0_OR_GREATER && !NETSTANDARD2_1_OR_GREATER -->
  <ItemGroup Condition="('$(InjectIndexRangeOnLegacy)' == 'true' OR '$(InjectANcpLuaIndexRangePolyfills)' == 'true') AND '$(_NeedsNetCoreApp31Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/IndexRange/Index.cs" LinkBase="Shared/Polyfills/IndexRange" Visible="false"/>
    <Compile Include="$(_SharedSourcePath)Polyfills/IndexRange/Range.cs" LinkBase="Shared/Polyfills/IndexRange" Visible="false"/>
  </ItemGroup>

  <!-- ParamCollectionAttribute (< net9.0) - enables C# 13 params collections -->
  <ItemGroup Condition="('$(InjectParamCollectionOnLegacy)' == 'true' OR '$(InjectANcpLuaLanguageFeaturesPolyfills)' == 'true') AND '$(_NeedsNet9Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/LanguageFeatures/ParamCollectionAttribute.cs" LinkBase="Shared/Polyfills/LanguageFeatures" Visible="false"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       EXCEPTIONS (< net7.0)
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="('$(InjectUnreachableExceptionOnLegacy)' == 'true' OR '$(InjectANcpLuaExceptionPolyfills)' == 'true') AND '$(_NeedsNet7Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/Exceptions/UnreachableException.cs" LinkBase="Shared/Polyfills/Exceptions" Visible="false"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       EXPERIMENTAL (< net8.0)
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="('$(InjectExperimentalAttributeOnLegacy)' == 'true' OR '$(InjectANcpLuaExperimentalPolyfills)' == 'true') AND '$(_NeedsNet8Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/Experimental/ExperimentalAttribute.cs" LinkBase="Shared/Polyfills/Experimental" Visible="false"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       DIAGNOSTICS (< net6.0)
       StackTraceHiddenAttribute
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectDiagnosticClassesOnLegacy)' == 'true' AND ('$(TargetFramework)' == 'netstandard2.0' OR '$(TargetFramework)' == 'net472')">
    <Compile Include="$(_SharedSourcePath)Polyfills/DiagnosticClasses.cs" LinkBase="Shared/Polyfills" Visible="false"/>
  </ItemGroup>

  <ItemGroup Condition="('$(InjectStackTraceHiddenOnLegacy)' == 'true' OR '$(InjectANcpLuaDiagnosticsPolyfills)' == 'true') AND '$(_NeedsNet6Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/Diagnostics/StackTraceHiddenAttribute.cs" LinkBase="Shared/Polyfills/Diagnostics" Visible="false"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       EXTENSIONS - Utility Types (All TFMs)
       ═══════════════════════════════════════════════════════════════════════ -->

  <!-- ─────────────────────────────────────────────────────────────────────────
       THROW / GUARD CLAUSES
       Microsoft.Shared.Diagnostics.Throw
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectSharedThrow)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Throw/Throw.cs" LinkBase="Shared/Throw" Visible="false"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       FAKE LOGGER
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectFakeLogger)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Extensions/FakeLogger/FakeLoggerExtensions.cs" LinkBase="Shared/Extensions/FakeLogger" Visible="false"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       INTEGRATION TESTS
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectANcpLuaIntegrationTestHelpers)' == 'true'">
    <Compile Include="$(_SharedSourcePath)IntegrationTests/*.cs" LinkBase="Shared/IntegrationTests" Visible="false"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       SOURCE GENERATOR HELPERS
       EquatableArray<T>, DiagnosticInfo, LocationInfo, CompilationExtensions, etc.
       ───────────────────────────────────────────────────────────────────────── -->
  <PropertyGroup Condition="'$(InjectSourceGenHelpers)' == 'true'">
    <DefineConstants>$(DefineConstants);ANCPLUA_SOURCEGEN_HELPERS</DefineConstants>
  </PropertyGroup>
  <ItemGroup Condition="'$(InjectSourceGenHelpers)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Extensions/SourceGen/*.cs" LinkBase="Shared/Extensions/SourceGen" Visible="false"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       COMMON COMPARERS
       StringOrdinalComparer
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectCommonComparers)' == 'true' OR '$(InjectStringOrdinalComparer)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Extensions/Comparers/*.cs" LinkBase="Shared/Extensions/Comparers" Visible="false"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       POLYFILLS - Lock & TimeProvider
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectLockPolyfill)' == 'true' AND '$(_NeedsNet9Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/Lock.cs" LinkBase="Shared/Polyfills" Visible="false"/>
  </ItemGroup>

  <ItemGroup Condition="('$(InjectTimeProviderPolyfill)' == 'true' OR '$(InjectANcpLuaTimeProviderPolyfill)' == 'true') AND '$(_NeedsNet8Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills/TimeProvider/TimeProvider.cs" LinkBase="Shared/Polyfills" Visible="false"/>
    <!-- TimeProvider on legacy frameworks requires IAsyncDisposable and ValueTask -->
    <PackageReference Include="Microsoft.Bcl.AsyncInterfaces" Version="6.0.0" Condition="'$(TargetFramework)' == 'netstandard2.0' or '$(TargetFramework)' == 'net462'"/>
    <PackageReference Include="System.Threading.Tasks.Extensions" Version="4.5.4" Condition="'$(TargetFramework)' == 'netstandard2.0' or '$(TargetFramework)' == 'net462'"/>
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       WORKFLOWS
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(EnableANcpLuaSharedWorkflows)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Workflows/**/*.cs" LinkBase="Shared/Workflows" Visible="false"/>
  </ItemGroup>

  <!-- ═══════════════════════════════════════════════════════════════════════
       BINLOG EMBEDDING (for diagnostics)
       ═══════════════════════════════════════════════════════════════════════ -->
  <Target Name="EmbedSharedSourcesInBinLog" AfterTargets="CoreCompile">
    <ItemGroup>
      <EmbedInBinlog Include="@(Compile)" Condition="$([System.String]::new('%(Identity)').Contains('Shared\'))"/>
    </ItemGroup>
  </Target>

</Project>