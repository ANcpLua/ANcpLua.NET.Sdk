<!--
  LegacySupport.targets - Polyfill and extension injection

  Injects shared source files into projects based on:
  1. The properties set in the project (InjectXxx)
  2. The target framework (only inject when needed)
-->
<Project>

  <!-- ═══════════════════════════════════════════════════════════════════════
       POLYFILLS - BCL Types for Older TFMs
       ═══════════════════════════════════════════════════════════════════════ -->

  <!-- ─────────────────────────────────────────────────────────────────────────
       TRIM ATTRIBUTES (< net5.0)
       RequiresUnreferencedCodeAttribute, RequiresDynamicCodeAttribute,
       DynamicallyAccessedMembersAttribute, UnconditionalSuppressMessageAttribute
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectTrimAttributesOnLegacy)' == 'true' AND '$(_NeedsNet5Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\TrimAttributes\*.cs" LinkBase="Shared\Polyfills\TrimAttributes" Visible="false" />
  </ItemGroup>

  <!-- RequiresDynamicCodeAttribute came in net7.0 -->
  <ItemGroup Condition="'$(InjectTrimAttributesOnLegacy)' == 'true' AND '$(_NeedsNet7Polyfills)' == 'true' AND '$(_NeedsNet5Polyfills)' != 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\TrimAttributes\RequiresDynamicCodeAttribute.cs" LinkBase="Shared\Polyfills\TrimAttributes" Visible="false" />
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       NULLABILITY ATTRIBUTES (< netcoreapp3.1)
       AllowNull, DisallowNull, MaybeNull, NotNull, DoesNotReturn, etc.
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectNullabilityAttributesOnLegacy)' == 'true' AND '$(_NeedsNetCoreApp31Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\NullabilityAttributes\NullableAttributes.cs" LinkBase="Shared\Polyfills\NullabilityAttributes" Visible="false" />
  </ItemGroup>

  <!-- MemberNotNull/MemberNotNullWhen came in net5.0 (always include if enabled, has #if guards) -->
  <ItemGroup Condition="'$(InjectNullabilityAttributesOnLegacy)' == 'true' AND '$(_NeedsNet5Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\NullabilityAttributes\MemberNotNullAttributes.cs" LinkBase="Shared\Polyfills\NullabilityAttributes" Visible="false" />
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       LANGUAGE FEATURES
       ───────────────────────────────────────────────────────────────────────── -->

  <!-- IsExternalInit (< net5.0) - enables records -->
  <ItemGroup Condition="'$(InjectIsExternalInitOnLegacy)' == 'true' AND '$(_NeedsNet5Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\LanguageFeatures\IsExternalInit.cs" LinkBase="Shared\Polyfills\LanguageFeatures" Visible="false" />
  </ItemGroup>

  <!-- RequiredMemberAttribute (< net7.0) - enables 'required' keyword -->
  <ItemGroup Condition="'$(InjectRequiredMemberOnLegacy)' == 'true' AND '$(_NeedsNet7Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\LanguageFeatures\RequiredMemberAttribute.cs" LinkBase="Shared\Polyfills\LanguageFeatures" Visible="false" />
  </ItemGroup>

  <!-- CompilerFeatureRequiredAttribute (< net7.0) - required for 'required' keyword -->
  <ItemGroup Condition="'$(InjectCompilerFeatureRequiredOnLegacy)' == 'true' AND '$(_NeedsNet7Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\LanguageFeatures\CompilerFeatureRequiredAttribute.cs" LinkBase="Shared\Polyfills\LanguageFeatures" Visible="false" />
  </ItemGroup>

  <!-- CallerArgumentExpressionAttribute (< net6.0) -->
  <ItemGroup Condition="'$(InjectCallerAttributesOnLegacy)' == 'true' AND '$(_NeedsNet6Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\LanguageFeatures\CallerArgumentExpressionAttribute.cs" LinkBase="Shared\Polyfills\LanguageFeatures" Visible="false" />
  </ItemGroup>

  <!-- Index and Range (< netcoreapp3.0 / netstandard2.1) - enables arr[^1], arr[1..3] -->
  <!-- These have #if guards: !NETCOREAPP3_0_OR_GREATER && !NETSTANDARD2_1_OR_GREATER -->
  <ItemGroup Condition="'$(InjectIndexRangeOnLegacy)' == 'true' AND '$(_NeedsNetCoreApp31Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\IndexRange\Index.cs" LinkBase="Shared\Polyfills\IndexRange" Visible="false" />
    <Compile Include="$(_SharedSourcePath)Polyfills\IndexRange\Range.cs" LinkBase="Shared\Polyfills\IndexRange" Visible="false" />
  </ItemGroup>

  <!-- ParamCollectionAttribute (< net9.0) - enables C# 13 params collections -->
  <ItemGroup Condition="'$(InjectParamCollectionOnLegacy)' == 'true' AND '$(_NeedsNet9Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\LanguageFeatures\ParamCollectionAttribute.cs" LinkBase="Shared\Polyfills\LanguageFeatures" Visible="false" />
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       EXCEPTIONS (< net7.0)
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectUnreachableExceptionOnLegacy)' == 'true' AND '$(_NeedsNet7Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\Exceptions\UnreachableException.cs" LinkBase="Shared\Polyfills\Exceptions" Visible="false" />
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       EXPERIMENTAL (< net8.0)
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectExperimentalAttributeOnLegacy)' == 'true' AND '$(_NeedsNet8Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\Experimental\ExperimentalAttribute.cs" LinkBase="Shared\Polyfills\Experimental" Visible="false" />
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       DIAGNOSTICS (< net6.0)
       StackTraceHiddenAttribute
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectStackTraceHiddenOnLegacy)' == 'true' AND '$(_NeedsNet6Polyfills)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Polyfills\Diagnostics\StackTraceHiddenAttribute.cs" LinkBase="Shared\Polyfills\Diagnostics" Visible="false" />
  </ItemGroup>

  <!-- ═══════════════════════════════════════════════════════════════════════
       EXTENSIONS - Utility Types (All TFMs)
       ═══════════════════════════════════════════════════════════════════════ -->

  <!-- ─────────────────────────────────────────────────────────────────────────
       THROW / GUARD CLAUSES
       Microsoft.Shared.Diagnostics.Throw
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectSharedThrow)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Extensions\Diagnostics\Throw.cs" LinkBase="Shared\Extensions\Diagnostics" Visible="false" />
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       SOURCE GENERATOR HELPERS
       EquatableArray<T>, DiagnosticInfo, LocationInfo, CompilationExtensions, etc.
       ───────────────────────────────────────────────────────────────────────── -->
  <PropertyGroup Condition="'$(InjectSourceGenHelpers)' == 'true'">
    <DefineConstants>$(DefineConstants);ANCPLUA_SOURCEGEN_HELPERS</DefineConstants>
  </PropertyGroup>
  <ItemGroup Condition="'$(InjectSourceGenHelpers)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Extensions\SourceGen\EquatableArray.cs" LinkBase="Shared\Extensions\SourceGen" Visible="false" />
    <Compile Include="$(_SharedSourcePath)Extensions\SourceGen\DiagnosticInfo.cs" LinkBase="Shared\Extensions\SourceGen" Visible="false" />
    <Compile Include="$(_SharedSourcePath)Extensions\SourceGen\LocationInfo.cs" LinkBase="Shared\Extensions\SourceGen" Visible="false" />
    <Compile Include="$(_SharedSourcePath)Extensions\SourceGen\EquatableMessageArgs.cs" LinkBase="Shared\Extensions\SourceGen" Visible="false" />
    <Compile Include="$(_SharedSourcePath)Extensions\SourceGen\CompilationExtensions.cs" LinkBase="Shared\Extensions\SourceGen" Visible="false" />
    <Compile Include="$(_SharedSourcePath)Extensions\SourceGen\AnalyzerConfigOptionsProviderExtensions.cs" LinkBase="Shared\Extensions\SourceGen" Visible="false" />
    <Compile Include="$(_SharedSourcePath)Extensions\SourceGen\DiagnosticsExtensions.cs" LinkBase="Shared\Extensions\SourceGen" Visible="false" />
    <Compile Include="$(_SharedSourcePath)Extensions\SourceGen\SyntaxValueProvider.cs" LinkBase="Shared\Extensions\SourceGen" Visible="false" />
    <Compile Include="$(_SharedSourcePath)Extensions\SourceGen\SourceProductionContextExtensions.cs" LinkBase="Shared\Extensions\SourceGen" Visible="false" />
    <Compile Include="$(_SharedSourcePath)Extensions\SourceGen\SymbolExtensions.cs" LinkBase="Shared\Extensions\SourceGen" Visible="false" />
  </ItemGroup>

  <!-- ─────────────────────────────────────────────────────────────────────────
       COMMON COMPARERS
       StringOrdinalComparer, TypePairComparer
       ───────────────────────────────────────────────────────────────────────── -->
  <ItemGroup Condition="'$(InjectCommonComparers)' == 'true'">
    <Compile Include="$(_SharedSourcePath)Extensions\Comparers\*.cs" LinkBase="Shared\Extensions\Comparers" Visible="false" />
  </ItemGroup>

  <!-- ═══════════════════════════════════════════════════════════════════════
       BINLOG EMBEDDING (for diagnostics)
       ═══════════════════════════════════════════════════════════════════════ -->
  <Target Name="EmbedSharedSourcesInBinLog" AfterTargets="CoreCompile">
    <ItemGroup>
      <EmbedInBinlog Include="@(Compile)" Condition="$([System.String]::new('%(Identity)').Contains('Shared\'))" />
    </ItemGroup>
  </Target>

</Project>
