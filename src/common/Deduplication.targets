<Project>
  <!--
    ═══════════════════════════════════════════════════════════════════════════
    INTELLIGENT DEDUPLICATION (MSBuild 16.6+)
    ═══════════════════════════════════════════════════════════════════════════
  -->

  <!-- Deduplicate output files by TargetPath -->
  <Target Name="_DeduplicateOutputFiles"
          BeforeTargets="CopyFilesToOutputDirectory">
    <ItemGroup>
      <_TransitiveItemsToCopyToOutputDirectory
          Remove="@(_ThisProjectItemsToCopyToOutputDirectory)"
          MatchOnMetadata="TargetPath"
          MatchOnMetadataOptions="PathLike" />
    </ItemGroup>
  </Target>

  <!-- Deduplicate Content items by Link using RemoveDuplicates task -->
  <Target Name="_DeduplicateContentItems"
          BeforeTargets="AssignTargetPaths">
    <RemoveDuplicates Inputs="@(Content)">
      <Output TaskParameter="Filtered" ItemName="_UniqueContent"/>
    </RemoveDuplicates>
    <ItemGroup>
      <Content Remove="@(Content)"/>
      <Content Include="@(_UniqueContent)"/>
    </ItemGroup>
  </Target>

  <!-- Deduplicate analyzer references by Filename using RemoveDuplicates task -->
  <Target Name="_DeduplicateAnalyzerReferences"
          BeforeTargets="ResolveAnalyzerReferences">
    <RemoveDuplicates Inputs="@(Analyzer)">
      <Output TaskParameter="Filtered" ItemName="_UniqueAnalyzer"/>
    </RemoveDuplicates>
    <ItemGroup>
      <Analyzer Remove="@(Analyzer)"/>
      <Analyzer Include="@(_UniqueAnalyzer)"/>
    </ItemGroup>
  </Target>

  <!-- Deduplicate Compile items by FullPath using RemoveDuplicates task -->
  <Target Name="_DeduplicateCompileItems"
          BeforeTargets="CoreCompile">
    <RemoveDuplicates Inputs="@(Compile)">
      <Output TaskParameter="Filtered" ItemName="_UniqueCompile"/>
    </RemoveDuplicates>
    <ItemGroup>
      <Compile Remove="@(Compile)"/>
      <Compile Include="@(_UniqueCompile)"/>
    </ItemGroup>
  </Target>
</Project>
