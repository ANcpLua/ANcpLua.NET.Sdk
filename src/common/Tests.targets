<Project>
  <!-- When running dotnet test, disable analyzers to compile faster and get feedback earlier -->
  <!-- This assume that most CI uses an actual dotnet build/publish/pack in parallel of dotnet test -->
  <PropertyGroup>
    <IsPackable>false</IsPackable>
    <EnableCodeCoverage Condition="'$(EnableCodeCoverage)' == '' AND '$(ContinuousIntegrationBuild)' == 'true'">true</EnableCodeCoverage>
  </PropertyGroup>

  <Target Name="DisableAnalyzerWhenRunningTests" BeforeTargets="VSTest;_MTPBuild" Condition="'$(OptimizeVsTestRun)' != 'false'">
    <PropertyGroup>
      <RunAnalyzers>false</RunAnalyzers>
    </PropertyGroup>
  </Target>

  <!-- ═══════════════════════════════════════════════════════════════════════
       MTP/VSTest Package Injection (via Target for correct timing)
       Runs after _DetectTestFrameworksAndMTP to see package-based detection results
       ═══════════════════════════════════════════════════════════════════════ -->
  <Target Name="_InjectTestingPackages" BeforeTargets="BeforeBuild;Restore;CollectPackageReferences" DependsOnTargets="_DetectTestFrameworksAndMTP">
    <!-- MTP v2 Extensions (NUnit, MSTest, TUnit - NOT xunit.v3 which has its own MTP implementation) -->
    <ItemGroup Condition="'$(UseMicrosoftTestingPlatform)' == 'true' AND '$(_UsesXunitV3Mtp)' != 'true'">
      <PackageReference Include="Microsoft.Testing.Extensions.CrashDump" Version="$(MTPExtensionsVersion)" IsImplicitlyDefined="true"/>
      <PackageReference Include="Microsoft.Testing.Extensions.CodeCoverage" Version="$(CodeCoverageVersion)" IsImplicitlyDefined="true"/>
      <PackageReference Include="Microsoft.Testing.Extensions.HangDump" Version="$(MTPExtensionsVersion)" IsImplicitlyDefined="true"/>
      <PackageReference Include="Microsoft.Testing.Extensions.HotReload" Version="$(MTPExtensionsVersion)" IsImplicitlyDefined="true"/>
      <PackageReference Include="Microsoft.Testing.Extensions.Retry" Version="$(MTPExtensionsVersion)" IsImplicitlyDefined="true"/>
      <PackageReference Include="Microsoft.Testing.Extensions.TrxReport" Version="$(MTPExtensionsVersion)" IsImplicitlyDefined="true"/>
    </ItemGroup>

    <!-- VSTest fallback (only when NOT using MTP) -->
    <ItemGroup Condition="'$(UseMicrosoftTestingPlatform)' != 'true'">
      <PackageReference Include="Microsoft.NET.Test.Sdk" Version="$(TestSdkVersion)" IsImplicitlyDefined="true"/>
    </ItemGroup>
  </Target>

  <!-- MTP CLI args must be set in a target AFTER detection to check _UsesXunitV3Mtp -->
  <Target Name="_SetMTPCommandLineArgs" BeforeTargets="Build;VSTest" DependsOnTargets="_DetectTestFrameworksAndMTP" Condition="'$(EnableDefaultTestSettings)' != 'false' AND '$(UseMicrosoftTestingPlatform)' == 'true'">
    <!-- Standard MTP extensions (NOT xunit.v3 which has its own options) -->
    <PropertyGroup Condition="'$(_UsesXunitV3Mtp)' != 'true'">
      <TestingPlatformCommandLineArguments>$(TestingPlatformCommandLineArguments) --report-trx</TestingPlatformCommandLineArguments>
      <TestingPlatformCommandLineArguments Condition="'$(EnableCodeCoverage)' == 'true'">$(TestingPlatformCommandLineArguments) --coverage</TestingPlatformCommandLineArguments>
      <TestingPlatformCommandLineArguments>$(TestingPlatformCommandLineArguments) --crashdump --crashdump-type mini</TestingPlatformCommandLineArguments>
      <TestingPlatformCommandLineArguments>$(TestingPlatformCommandLineArguments) --hangdump --hangdump-timeout 10m --hangdump-type mini</TestingPlatformCommandLineArguments>
    </PropertyGroup>
    <!-- xunit.v3 native MTP options -->
    <PropertyGroup Condition="'$(_UsesXunitV3Mtp)' == 'true'">
      <TestingPlatformCommandLineArguments>$(TestingPlatformCommandLineArguments) --report-xunit-trx</TestingPlatformCommandLineArguments>
    </PropertyGroup>
    <!-- Common options for all MTP -->
    <PropertyGroup>
      <TestingPlatformCommandLineArguments>$(TestingPlatformCommandLineArguments) --minimum-expected-tests 1</TestingPlatformCommandLineArguments>
    </PropertyGroup>
  </Target>

  <PropertyGroup Condition="'$(EnableDefaultTestSettings)' != 'false'">
    <VSTestBlame>true</VSTestBlame>

    <VSTestBlameCrash>true</VSTestBlameCrash>
    <VSTestBlameCrashDumpType>mini</VSTestBlameCrashDumpType>

    <VSTestBlameHang>true</VSTestBlameHang>
    <VSTestBlameHangDumpType>mini</VSTestBlameHangDumpType>
    <VSTestBlameHangTimeout>10min</VSTestBlameHangTimeout>

    <VSTestCollect Condition="'$(EnableCodeCoverage)' == 'true'">Code Coverage</VSTestCollect>
    <VSTestSetting Condition="'$(EnableCodeCoverage)' == 'true'">$(MSBuildThisFileDirectory)..\configuration\default.runsettings</VSTestSetting>
  </PropertyGroup>

  <PropertyGroup>
    <VSTestLogger Condition="'$(VSTestLogger)' != ''">$(VSTestLogger);</VSTestLogger>
    <VSTestLogger>$(VSTestLogger)trx;console%3bverbosity=normal</VSTestLogger>
  </PropertyGroup>

  <!-- Add implicit using for xunit -->
  <ItemGroup Condition="'$(ImplicitUsings)' == 'enable' AND (
                            @(PackageReference-&gt;AnyHaveMetadataValue('Identity', 'xunit')) == 'true' OR
                            @(PackageReference-&gt;AnyHaveMetadataValue('Identity', 'xunit.v3')) == 'true' OR
                            @(PackageReference-&gt;AnyHaveMetadataValue('Identity', 'xunit.v3.mtp-v1')) == 'true' OR
                            @(PackageReference-&gt;AnyHaveMetadataValue('Identity', 'xunit.v3.mtp-v2')) == 'true'
                            )">
    <Using Include="Xunit"/>
  </ItemGroup>

  <!-- ═══════════════════════════════════════════════════════════════════════
       TEST EXTENSIONS (Auto-injected for test projects)
       ═══════════════════════════════════════════════════════════════════════ -->

  <!-- FakeLogger for testing - auto-inject -->
  <ItemGroup Condition="'$(InjectFakeLogger)' != 'false'">
    <PackageReference Include="Microsoft.Extensions.Diagnostics.Testing" Version="$(DiagnosticsTestingVersion)" IsImplicitlyDefined="true"/>
    <Using Include="Microsoft.Extensions.Diagnostics.Testing"/>
  </ItemGroup>
  <ItemGroup Condition="'$(InjectFakeLogger)' != 'false'">
    <Compile Include="$(MSBuildThisFileDirectory)..\..\eng\Extensions\FakeLogger\*.cs" LinkBase="ANcpLua.Generated\FakeLogger" Visible="false"/>
  </ItemGroup>

  <!-- XunitLogger (ITestOutputHelper → ILogger bridge) -->
  <ItemGroup Condition="'$(InjectXunitLogger)' == 'true'">
    <Compile Include="$(MSBuildThisFileDirectory)..\..\eng\Shared\Samples\XunitLogger.cs" LinkBase="ANcpLua.Generated\Testing" Visible="false"/>
    <Compile Include="$(MSBuildThisFileDirectory)..\..\eng\Shared\Samples\TextOutputHelperExtensions.cs" LinkBase="ANcpLua.Generated\Testing" Visible="false"/>
  </ItemGroup>

  <!-- Compiler helper for source generator tests -->
  <ItemGroup Condition="'$(InjectCompilerHelper)' == 'true'">
    <Compile Include="$(MSBuildThisFileDirectory)..\..\eng\Shared\CodeTests\Compiler.cs" LinkBase="ANcpLua.Generated\CodeTests" Visible="false"/>
  </ItemGroup>

  <!-- Integration test configurations (OpenAI, Anthropic) -->
  <ItemGroup Condition="'$(InjectIntegrationTestConfigs)' == 'true'">
    <Compile Include="$(MSBuildThisFileDirectory)..\..\eng\Shared\IntegrationTests\*.cs" LinkBase="ANcpLua.Generated\IntegrationTests" Visible="false"/>
  </ItemGroup>

  <!-- GitHub Actions Test Reporting (via Target for correct timing) -->
  <Target Name="_InjectGitHubActionsLogger" BeforeTargets="BeforeBuild;Restore;CollectPackageReferences" DependsOnTargets="_DetectTestFrameworksAndMTP" Condition="'$(_IsGitHubActions)' == 'true'">
    <!-- MTP: GitHubActionsTestLogger auto-registers -->
    <ItemGroup Condition="'$(UseMicrosoftTestingPlatform)' == 'true'">
      <PackageReference Include="GitHubActionsTestLogger" Version="$(GitHubActionsLoggerMTPVersion)" IsImplicitlyDefined="true"/>
    </ItemGroup>

    <!-- VSTest: GitHubActionsTestLogger with logger config -->
    <PropertyGroup Condition="'$(UseMicrosoftTestingPlatform)' != 'true'">
      <VSTestLogger>$(VSTestLogger);GitHubActions</VSTestLogger>
    </PropertyGroup>
    <ItemGroup Condition="'$(UseMicrosoftTestingPlatform)' != 'true'">
      <PackageReference Include="GitHubActionsTestLogger" Version="$(GitHubActionsLoggerVSTestVersion)" IsImplicitlyDefined="true">
        <PrivateAssets>all</PrivateAssets>
        <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
      </PackageReference>
    </ItemGroup>
  </Target>

</Project>
