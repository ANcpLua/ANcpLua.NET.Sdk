<Project>
  <!-- When running dotnet test, disable analyzers to compile faster and get feedback earlier -->
  <!-- This assume that most CI uses an actual dotnet build/publish/pack in parallel of dotnet test -->
  <PropertyGroup>
    <IsPackable>false</IsPackable>
    <EnableCodeCoverage Condition="'$(EnableCodeCoverage)' == '' AND '$(ContinuousIntegrationBuild)' == 'true'">true</EnableCodeCoverage>
  </PropertyGroup>

  <!-- Disable analyzers for Microsoft.Testing.Platform test projects unless explicitly opted out -->
  <PropertyGroup Condition="'$(UseMicrosoftTestingPlatform)' == 'true' AND '$(OptimizeMtpTestRun)' != 'false'">
    <RunAnalyzers>false</RunAnalyzers>
  </PropertyGroup>

  <Target Name="DisableAnalyzerWhenRunningTests" BeforeTargets="_MTPBuild" Condition="'$(OptimizeMtpTestRun)' != 'false'">
    <PropertyGroup>
      <RunAnalyzers>false</RunAnalyzers>
    </PropertyGroup>
  </Target>

  <!-- Add implicit using for xunit (via Target for correct timing - items require Target) -->
  <Target Name="_InjectXunitUsings" BeforeTargets="BeforeBuild;CollectPackageReferences" DependsOnTargets="_DetectTestFrameworksAndMTP" Condition="'$(ImplicitUsings)' == 'enable'">
    <!-- Filter xUnit packages using correct MSBuild syntax -->
    <ItemGroup>
      <_XunitUsings Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit'" />
      <_XunitUsings Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit.v3'" />
      <_XunitUsings Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit.v3.mtp-v1'" />
      <_XunitUsings Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit.v3.mtp-v2'" />
    </ItemGroup>
    <ItemGroup Condition="'@(_XunitUsings)' != ''">
      <Using Include="Xunit"/>
    </ItemGroup>
  </Target>

  <!-- ═══════════════════════════════════════════════════════════════════════
       TEST EXTENSIONS (Auto-injected for test projects)
       ═══════════════════════════════════════════════════════════════════════ -->

  <!-- FakeLogger for testing - auto-inject -->
  <ItemGroup Condition="'$(InjectFakeLogger)' != 'false'">
    <PackageReference Include="Microsoft.Extensions.Diagnostics.Testing" Version="$(DiagnosticsTestingVersion)" IsImplicitlyDefined="true"/>
    <Using Include="Microsoft.Extensions.Diagnostics.Testing"/>
  </ItemGroup>
  <ItemGroup Condition="'$(InjectFakeLogger)' != 'false'">
    <Compile Include="$(MSBuildThisFileDirectory)..\..\eng\Extensions\FakeLogger\*.cs" LinkBase="ANcpLua.Generated\FakeLogger" Visible="false"/>
  </ItemGroup>

  <!-- XunitLogger (ITestOutputHelper → ILogger bridge) -->
  <ItemGroup Condition="'$(InjectXunitLogger)' == 'true'">
    <Compile Include="$(MSBuildThisFileDirectory)..\..\eng\Shared\Samples\XunitLogger.cs" LinkBase="ANcpLua.Generated\Testing" Visible="false"/>
    <Compile Include="$(MSBuildThisFileDirectory)..\..\eng\Shared\Samples\TextOutputHelperExtensions.cs" LinkBase="ANcpLua.Generated\Testing" Visible="false"/>
  </ItemGroup>

  <!-- Compiler helper for source generator tests -->
  <ItemGroup Condition="'$(InjectCompilerHelper)' == 'true'">
    <Compile Include="$(MSBuildThisFileDirectory)..\..\eng\Shared\CodeTests\Compiler.cs" LinkBase="ANcpLua.Generated\CodeTests" Visible="false"/>
  </ItemGroup>

  <!-- Integration test configurations (OpenAI, Anthropic) -->
  <ItemGroup Condition="'$(InjectIntegrationTestConfigs)' == 'true'">
    <Compile Include="$(MSBuildThisFileDirectory)..\..\eng\Shared\IntegrationTests\*.cs" LinkBase="ANcpLua.Generated\IntegrationTests" Visible="false"/>
  </ItemGroup>

  <!-- GitHub Actions Test Reporting (via Target for correct timing) -->
  <Target Name="_InjectGitHubActionsLogger" BeforeTargets="BeforeBuild;Restore;CollectPackageReferences" DependsOnTargets="_DetectTestFrameworksAndMTP" Condition="'$(_IsGitHubActions)' == 'true'">
    <!-- MTP: GitHubActionsTestLogger auto-registers -->
    <ItemGroup>
      <PackageReference Include="GitHubActionsTestLogger" Version="$(GitHubActionsLoggerMTPVersion)" IsImplicitlyDefined="true"/>
    </ItemGroup>
  </Target>

</Project>
