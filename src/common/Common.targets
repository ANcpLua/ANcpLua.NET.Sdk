<Project>
  <!-- Default TargetFramework to latest .NET if not specified -->
  <PropertyGroup>
    <TargetFramework Condition="'$(TargetFramework)' == '' AND '$(TargetFrameworks)' == ''">net$(NETCoreAppMaximumVersion)</TargetFramework>
  </PropertyGroup>

  <!-- ═══════════════════════════════════════════════════════════════════════
       AUTO-DETECT TEST/MTP PROJECTS (Smart SDK)

       Property-based detection (during import phase):
       - EnableNUnitRunner / EnableMSTestRunner / UseMicrosoftTestingPlatform

       Package-based detection (via Target, runs before build):
       - Test frameworks: xunit, xunit.v3, NUnit, MSTest.TestFramework, TUnit
       - MTP signals: xunit.v3.mtp-v1/v2, TUnit, Microsoft.Testing.Extensions.*
       ═══════════════════════════════════════════════════════════════════════ -->

  <!-- ═══════════════════════════════════════════════════════════════════════
       STEP 1: Property-based MTP detection (works during import)
       Case-insensitive comparison - MSBuild compares strings case-insensitively
       ═══════════════════════════════════════════════════════════════════════ -->
  <PropertyGroup>
    <!-- Track if user explicitly set UseMicrosoftTestingPlatform=true (for warning purposes) -->
    <_MTPExplicitlySet Condition="'$(UseMicrosoftTestingPlatform)' == 'true'">true</_MTPExplicitlySet>
    <!-- Explicit opt-in via property enables MTP -->
    <_UsesMTP Condition="'$(UseMicrosoftTestingPlatform)' == 'true' OR '$(EnableNUnitRunner)' == 'true' OR '$(EnableMSTestRunner)' == 'true'">true</_UsesMTP>
  </PropertyGroup>

  <!-- MTP auto-configuration when detected via property -->
  <PropertyGroup Condition="'$(_UsesMTP)' == 'true'">
    <!-- Auto-set OutputType to Exe ONLY if MTP was not explicitly set by user with OutputType=Library -->
    <!-- If user explicitly set UseMicrosoftTestingPlatform=true AND OutputType=Library, don't auto-correct (warn instead via _ValidateMTPConfiguration) -->
    <OutputType Condition="'$(OutputType)' == 'Library' AND '$(_MTPExplicitlySet)' != 'true'">Exe</OutputType>
    <OutputType Condition="'$(OutputType)' == ''">Exe</OutputType>
    <TestingPlatformDotnetTestSupport Condition="'$(TestingPlatformDotnetTestSupport)' == ''">true</TestingPlatformDotnetTestSupport>
    <UseMicrosoftTestingPlatform Condition="'$(UseMicrosoftTestingPlatform)' == ''">true</UseMicrosoftTestingPlatform>
  </PropertyGroup>

  <!-- ═══════════════════════════════════════════════════════════════════════
       STEP 2: Package-based MTP detection (via Target - item functions require Target)
       Runs very early to set properties before other targets use them
       ═══════════════════════════════════════════════════════════════════════ -->
  <Target Name="_DetectTestFrameworksAndMTP" BeforeTargets="BeforeBuild;Restore;CollectPackageReferences" Condition="'$(_ANcpLuaTestDetectionDone)' != 'true'">
    <PropertyGroup>
      <_ANcpLuaTestDetectionDone>true</_ANcpLuaTestDetectionDone>
    </PropertyGroup>

    <!-- Filter test framework packages -->
    <ItemGroup>
      <_TUnitPkg Include="@(PackageReference)" Condition="'%(Identity)' == 'TUnit'"/>
      <_NUnitPkg Include="@(PackageReference)" Condition="'%(Identity)' == 'NUnit'"/>
      <_MSTestPkg Include="@(PackageReference)" Condition="'%(Identity)' == 'MSTest.TestFramework'"/>
      <_XunitMtpV1Pkg Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit.v3.mtp-v1'"/>
      <_XunitMtpV2Pkg Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit.v3.mtp-v2'"/>
      <_XunitMtpOffPkg Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit.v3.mtp-off'"/>
      <_MtpExtPkg Include="@(PackageReference)" Condition="$([System.String]::new('%(Identity)').StartsWith('Microsoft.Testing.Extensions'))"/>
    </ItemGroup>

    <!-- Skip xunit injection when other test frameworks are present -->
    <PropertyGroup>
      <SkipXunitInjection Condition="'@(_TUnitPkg)' != ''">true</SkipXunitInjection>
      <SkipXunitInjection Condition="'@(_NUnitPkg)' != ''">true</SkipXunitInjection>
      <SkipXunitInjection Condition="'@(_MSTestPkg)' != ''">true</SkipXunitInjection>
    </PropertyGroup>

    <!-- Detect MTP usage (strict) - only EXPLICIT MTP signals -->
    <PropertyGroup Condition="'$(_UsesMTP)' != 'true'">
      <!-- TUnit is always MTP -->
      <_UsesMTP Condition="'@(_TUnitPkg)' != ''">true</_UsesMTP>
      <_UsesTUnit Condition="'@(_TUnitPkg)' != ''">true</_UsesTUnit>
      <!-- xUnit v3 MTP packages (have their own MTP implementation, don't inject standard extensions) -->
      <_UsesMTP Condition="'@(_XunitMtpV1Pkg)' != ''">true</_UsesMTP>
      <_UsesXunitV3Mtp Condition="'@(_XunitMtpV1Pkg)' != ''">true</_UsesXunitV3Mtp>
      <_UsesMTP Condition="'@(_XunitMtpV2Pkg)' != ''">true</_UsesMTP>
      <_UsesXunitV3Mtp Condition="'@(_XunitMtpV2Pkg)' != ''">true</_UsesXunitV3Mtp>
      <!-- Microsoft.Testing.Extensions.* packages -->
      <_UsesMTP Condition="'@(_MtpExtPkg)' != ''">true</_UsesMTP>
    </PropertyGroup>

    <!-- xunit.v3.mtp-off explicitly opts OUT of MTP -->
    <PropertyGroup Condition="'@(_XunitMtpOffPkg)' != ''">
      <_UsesMTP>false</_UsesMTP>
    </PropertyGroup>

    <!-- Set UseMicrosoftTestingPlatform and configure MTP mode -->
    <PropertyGroup Condition="'$(_UsesMTP)' == 'true'">
      <UseMicrosoftTestingPlatform Condition="'$(UseMicrosoftTestingPlatform)' == ''">true</UseMicrosoftTestingPlatform>
      <!-- Auto-set OutputType to Exe ONLY if MTP was not explicitly set by user with OutputType=Library -->
      <OutputType Condition="'$(OutputType)' == 'Library' AND '$(_MTPExplicitlySet)' != 'true'">Exe</OutputType>
      <OutputType Condition="'$(OutputType)' == ''">Exe</OutputType>
      <TestingPlatformDotnetTestSupport Condition="'$(TestingPlatformDotnetTestSupport)' == ''">true</TestingPlatformDotnetTestSupport>
    </PropertyGroup>

    <!-- Use item-based condition directly since property may not be updated in same target -->
    <PropertyGroup Condition="'@(_XunitMtpV1Pkg)' != '' OR '@(_XunitMtpV2Pkg)' != ''">
      <TestingPlatformCommandLineArguments Condition="'$(TestingPlatformCommandLineArguments)' == ''">--report-xunit-trx</TestingPlatformCommandLineArguments>
    </PropertyGroup>

    <!-- Inject MTP extensions for non-xunit MTP frameworks (TUnit, NUnit MTP, MSTest MTP) -->
    <!-- xunit.v3.mtp has its own implementation, skip for those -->
    <ItemGroup Condition="'@(_TUnitPkg)' != '' OR ('$(EnableNUnitRunner)' == 'true') OR ('$(EnableMSTestRunner)' == 'true')">
      <PackageReference Include="Microsoft.Testing.Extensions.CrashDump" Version="$(MTPExtensionsVersion)" IsImplicitlyDefined="true"/>
      <PackageReference Include="Microsoft.Testing.Extensions.HangDump" Version="$(MTPExtensionsVersion)" IsImplicitlyDefined="true"/>
      <PackageReference Include="Microsoft.Testing.Extensions.TrxReport" Version="$(MTPExtensionsVersion)" IsImplicitlyDefined="true"/>
      <PackageReference Include="Microsoft.Testing.Extensions.CodeCoverage" Version="$(CodeCoverageVersion)" IsImplicitlyDefined="true"/>
      <PackageReference Include="Microsoft.Testing.Extensions.Retry" Version="$(MTPExtensionsVersion)" IsImplicitlyDefined="true"/>
      <PackageReference Include="Microsoft.Testing.Extensions.HotReload" Version="$(MTPExtensionsVersion)" IsImplicitlyDefined="true"/>
    </ItemGroup>

    <Message Text="ANcpLua.SDK Test Detection: _UsesMTP=$(_UsesMTP), _UsesXunitV3Mtp=$(_UsesXunitV3Mtp), _UsesTUnit=$(_UsesTUnit), SkipXunitInjection=$(SkipXunitInjection)" Importance="low"/>
  </Target>

  <!-- ═══════════════════════════════════════════════════════════════════════
       SAFETY GUARD: Detect contradictory MTP/OutputType state
       ═══════════════════════════════════════════════════════════════════════ -->
  <Target Name="_ValidateMTPConfiguration" BeforeTargets="Build" Condition="'$(IsTestProject)' == 'true'" DependsOnTargets="_DetectTestFrameworksAndMTP">
    <Warning
      Code="ANCPSDK001"
      Text="MTP is enabled (UseMicrosoftTestingPlatform=true) but OutputType is 'Library'. MTP test projects must be executables. Set OutputType=Exe or disable MTP."
      Condition="'$(UseMicrosoftTestingPlatform)' == 'true' AND '$(OutputType)' == 'Library'"/>
  </Target>

  <Import Project="$(MSBuildThisFileDirectory)/Tests.targets" Condition="'$(IsTestProject)' == 'true'"/>
  <Import Project="$(MSBuildThisFileDirectory)/Npm.targets"/>
  <Import Project="$(MSBuildThisFileDirectory)/LegacySupport.targets"/>
  <Import Project="$(MSBuildThisFileDirectory)/../Enforcement/VersionEnforcement.targets"/>

  <!-- ═══════════════════════════════════════════════════════════════════════
       ADDITIONAL FILES FOR ANALYZERS
       Expose .props files to analyzers for version management validation
       ═══════════════════════════════════════════════════════════════════════ -->
  <ItemGroup Condition="'$(DisableVersionAnalyzer)' != 'true'">
    <AdditionalFiles Include="$(MSBuildProjectDirectory)/Directory.Packages.props"
                     Condition="Exists('$(MSBuildProjectDirectory)/Directory.Packages.props')"
                     Visible="false"/>
    <AdditionalFiles Include="$([MSBuild]::GetPathOfFileAbove('Directory.Packages.props', '$(MSBuildProjectDirectory)'))"
                     Condition="!Exists('$(MSBuildProjectDirectory)/Directory.Packages.props') AND '$([MSBuild]::GetPathOfFileAbove(`Directory.Packages.props`, `$(MSBuildProjectDirectory)`))' != ''"
                     Visible="false"/>
  </ItemGroup>

  <PropertyGroup>
    <!-- SBOM generation: enabled on CI builds, disabled locally (user can override) -->
    <GenerateSBOM Condition="'$(GenerateSBOM)' == '' AND '$(ContinuousIntegrationBuild)' == 'true'">true</GenerateSBOM>
    <GenerateSBOM Condition="'$(GenerateSBOM)' == ''">false</GenerateSBOM>
  </PropertyGroup>

  <!-- ServiceDefaults - auto-added for Web projects -->
  <!-- ANcpSdkPackageVersion is set in Version.props (auto-generated by build.ps1) -->
  <ItemGroup Condition="'$(UsingMicrosoftNETSdkWeb)' == 'true' AND '$(DisableServiceDefaults)' != 'true'">
    <PackageReference Include="ANcpSdk.AspNetCore.ServiceDefaults" Version="$(ANcpSdkPackageVersion)" IsImplicitlyDefined="true"/>
    <PackageReference Include="ANcpSdk.AspNetCore.ServiceDefaults.AutoRegister" Version="$(ANcpSdkPackageVersion)" IsImplicitlyDefined="true" Condition="'$(AutoRegisterServiceDefaults)' != 'false'"/>
  </ItemGroup>

  <!-- Ensure application can run with newer frameworks -->
  <PropertyGroup>
    <RollForward Condition="'$(RollForward)' == '' AND '$(IsTestProject)' != 'true'">LatestMajor</RollForward>
  </PropertyGroup>

  <ItemGroup>
    <AssemblyAttribute Include="System.Reflection.AssemblyMetadataAttribute">
      <_Parameter1>ANcpLua.Sdk.Name</_Parameter1>
      <_Parameter2>$(ANcpLuaSdkName)</_Parameter2>
    </AssemblyAttribute>
  </ItemGroup>

  <!--
    SDK-injected analyzer packages.
    For CPM consumers: Version comes from Directory.Packages.props (PackageVersion entries).
    For non-CPM consumers: Version comes from SDK's Version.props variables.
  -->
  <ItemGroup Condition="'$(ManagePackageVersionsCentrally)' != 'true'">
    <!-- Non-CPM: SDK provides versions -->
    <PackageReference Include="ANcpLua.Analyzers" Version="$(ANcpLuaAnalyzersVersion)"
                      Condition="'$(PackageId)' != 'ANcpLua.Analyzers'">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    </PackageReference>

    <PackageReference Include="Microsoft.Sbom.Targets" Version="$(SbomTargetsVersion)">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    </PackageReference>

    <PackageReference Include="Microsoft.CodeAnalysis.BannedApiAnalyzers" Version="$(BannedApiAnalyzersVersion)">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    </PackageReference>

    <PackageReference Include="JonSkeet.RoslynAnalyzers" Version="$(JonSkeetAnalyzersVersion)">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    </PackageReference>
  </ItemGroup>

  <ItemGroup Condition="'$(ManagePackageVersionsCentrally)' == 'true'">
    <!-- CPM: Consumer's Directory.Packages.props provides versions via PackageVersion entries -->
    <PackageReference Include="ANcpLua.Analyzers"
                      Condition="'$(PackageId)' != 'ANcpLua.Analyzers'">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    </PackageReference>

    <PackageReference Include="Microsoft.Sbom.Targets">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    </PackageReference>

    <PackageReference Include="Microsoft.CodeAnalysis.BannedApiAnalyzers">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    </PackageReference>

    <PackageReference Include="JonSkeet.RoslynAnalyzers">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    </PackageReference>
  </ItemGroup>

  <ItemGroup>
    <AdditionalFiles Include="$(MSBuildThisFileDirectory)../configuration/BannedSymbols.txt" Condition="'$(IncludeDefaultBannedSymbols)' != 'false'" Visible="false"/>
    <AdditionalFiles Include="$(MSBuildThisFileDirectory)../configuration/BannedSymbols.NewtonsoftJson.txt" Condition="'$(BannedNewtonsoftJsonSymbols)' != 'false'" Visible="false"/>
  </ItemGroup>

  <ItemGroup Condition="'$(Language)' == 'C#' AND ('$(ImplicitUsings)' == 'true' or '$(ImplicitUsings)' == 'enable')">
    <Using Include="System.Diagnostics.CodeAnalysis"/>
    <Using Include="System.Globalization"/>
    <Using Include="System.Text"/>
  </ItemGroup>

  <Target Name="EmbedBannedSymbolsInBinLog" AfterTargets="CoreCompile">
    <ItemGroup>
      <EmbedInBinlog Include="@(AdditionalFiles)" Condition="$([System.Text.RegularExpressions.Regex]::IsMatch('%(Filename)%(Extension)', '^BannedSymbols(\..+)?\.txt$'))"/>
    </ItemGroup>
  </Target>

  <Target Name="EmbedEditorConfigInBinLog" AfterTargets="CoreCompile">
    <ItemGroup>
      <EmbedInBinlog Include="@(EditorConfigFiles)"/>
    </ItemGroup>
  </Target>

  <!-- ═══════════════════════════════════════════════════════════════════════
       CLAUDE.MD AUTO-GENERATION
       ═══════════════════════════════════════════════════════════════════════ -->
  <Target Name="GenerateClaudeMd" BeforeTargets="Build" Condition="'$(GenerateClaudeMd)' == 'true' AND !Exists('$(MSBuildProjectDirectory)/CLAUDE.md')">
    <PropertyGroup>
      <_RootClaudeMd>$([MSBuild]::GetPathOfFileAbove('CLAUDE.md', '$(MSBuildProjectDirectory)'))</_RootClaudeMd>
    </PropertyGroup>
    <WriteLinesToFile
      File="$(MSBuildProjectDirectory)/CLAUDE.md"
      Lines="---&#10;See [Root CLAUDE.md]($(_RootClaudeMd)) for project context.&#10;---&#10;&#10;# $(MSBuildProjectName)&#10;&#10;Project-specific context goes here."
      Overwrite="true"
      Condition="'$(_RootClaudeMd)' != ''"
    />
  </Target>

  <!-- Disable packages -->
  <Target Name="Disable_SponsorLink" BeforeTargets="CoreCompile" Condition="'$(Disable_SponsorLink)' != 'false'">
    <ItemGroup>
      <Analyzer Remove="@(Analyzer)" Condition="'%(Analyzer.Filename)' == 'DevLooped.SponsorLink'"/>
      <Analyzer Remove="@(Analyzer)" Condition="'%(Analyzer.Filename)' == 'Moq.CodeAnalysis'"/>
    </ItemGroup>
  </Target>

  <!-- NuGet Package -->
  <Choose>
    <When Condition="'$(PackageIcon)' == '' AND '$(_IsANcpLuaProject)' == 'true' AND Exists('$(MSBuildThisFileDirectory)../icon.png')">
      <PropertyGroup>
        <PackageIcon>icon.png</PackageIcon>
      </PropertyGroup>
      <ItemGroup>
        <None Include="$(MSBuildThisFileDirectory)../icon.png" Pack="true" PackagePath="" Visible="false"/>
      </ItemGroup>
    </When>
  </Choose>

  <PropertyGroup>
    <_PackageReadmeFilePath Condition="'$(_PackageReadmeFilePath)' == '' AND Exists('$(MSBuildProjectDirectory)/README.md')">$(MSBuildProjectDirectory)/README.md</_PackageReadmeFilePath>
    <_PackageReadmeFilePath Condition="'$(_PackageReadmeFilePath)' == '' AND Exists('$(MSBuildProjectDirectory)/readme.md')">$(MSBuildProjectDirectory)/readme.md</_PackageReadmeFilePath>
    <_PackageReadmeFilePath Condition="'$(_PackageReadmeFilePath)' == '' AND Exists('$(MSBuildProjectDirectory)/Readme.md')">$(MSBuildProjectDirectory)/Readme.md</_PackageReadmeFilePath>
    <_PackageReadmeFilePath Condition="'$(_PackageReadmeFilePath)' == '' AND Exists('$(MSBuildProjectDirectory)/ReadMe.md')">$(MSBuildProjectDirectory)/ReadMe.md</_PackageReadmeFilePath>

    <_PackageReadmeFilePath Condition="'$(_PackageReadmeFilePath)' == '' AND '$(SearchReadmeFileAbove)' == 'true' AND Exists($([MSBuild]::GetPathOfFileAbove('README.md', '$(MSBuildProjectDirectory)')))">$([MSBuild]::GetPathOfFileAbove('README.md', '$(MSBuildProjectDirectory)'))</_PackageReadmeFilePath>
    <_PackageReadmeFilePath Condition="'$(_PackageReadmeFilePath)' == '' AND '$(SearchReadmeFileAbove)' == 'true' AND Exists($([MSBuild]::GetPathOfFileAbove('readme.md', '$(MSBuildProjectDirectory)')))">$([MSBuild]::GetPathOfFileAbove('readme.md', '$(MSBuildProjectDirectory)'))</_PackageReadmeFilePath>
    <_PackageReadmeFilePath Condition="'$(_PackageReadmeFilePath)' == '' AND '$(SearchReadmeFileAbove)' == 'true' AND Exists($([MSBuild]::GetPathOfFileAbove('Readme.md', '$(MSBuildProjectDirectory)')))">$([MSBuild]::GetPathOfFileAbove('Readme.md', '$(MSBuildProjectDirectory)'))</_PackageReadmeFilePath>
    <_PackageReadmeFilePath Condition="'$(_PackageReadmeFilePath)' == '' AND '$(SearchReadmeFileAbove)' == 'true' AND Exists($([MSBuild]::GetPathOfFileAbove('ReadMe.md', '$(MSBuildProjectDirectory)')))">$([MSBuild]::GetPathOfFileAbove('ReadMe.md', '$(MSBuildProjectDirectory)'))</_PackageReadmeFilePath>

    <_PackageThirdPartyNoticesPath Condition="Exists('$(MSBuildProjectDirectory)/THIRD-PARTY-NOTICES.TXT')">$(MSBuildProjectDirectory)/THIRD-PARTY-NOTICES.TXT</_PackageThirdPartyNoticesPath>

    <_LicensePath Condition="Exists($([MSBuild]::GetPathOfFileAbove('LICENSE.txt')))">$([MSBuild]::GetPathOfFileAbove('LICENSE.txt'))</_LicensePath>

    <Authors Condition="'$(Authors)' == '' AND '$(_IsANcpLuaProject)' == 'true'">ANcpLua</Authors>
    <Company Condition="'$(Company)' == '' AND '$(_IsANcpLuaProject)' == 'true'">ANcpLua</Company>

    <PackageLicenseExpression Condition="'$(PackageLicenseExpression)' == '' AND '$(_IsANcpLuaProject)' == 'true'">MIT</PackageLicenseExpression>
    <PackageReadmeFile Condition="'$(PackageReadmeFile)' == '' AND '$(_PackageReadmeFilePath)' != ''">README.md</PackageReadmeFile>
  </PropertyGroup>

  <ItemGroup>
    <None Include="$(_PackageReadmeFilePath)" Pack="true" PackagePath="README.md" Condition="$(_PackageReadmeFilePath) != ''"/>
    <None Include="$(_PackageThirdPartyNoticesPath)" Pack="true" PackagePath="" Condition="$(_PackageThirdPartyNoticesPath) != ''"/>
    <None Include="$(_LicensePath)" Pack="true" PackagePath="" Visible="false" Condition="$(_LicensePath) != ''"/>
  </ItemGroup>

</Project>