<Project>
  <!--
    Determinism & git metadata wiring
    - Always set deterministic defaults (portable PDB + snupkg)
    - Compute git data at target execution time so temp folders (no .git) don't explode
  -->

  <PropertyGroup>
    <Deterministic>true</Deterministic>
    <ContinuousIntegrationBuild Condition="'$(CI)' == 'true'">true</ContinuousIntegrationBuild>
    <DebugType>portable</DebugType>
    <IncludeSymbols>true</IncludeSymbols>
    <SymbolPackageFormat>snupkg</SymbolPackageFormat>
    <EmbedAllSources Condition="'$(EmbedAllSources)' == ''">true</EmbedAllSources>
    <PublishRepositoryUrl Condition="'$(PublishRepositoryUrl)' == ''">true</PublishRepositoryUrl>
    <IncludeSourceRevisionInInformationalVersion Condition="'$(IncludeSourceRevisionInInformationalVersion)' == ''">true</IncludeSourceRevisionInInformationalVersion>
  </PropertyGroup>

  <!-- Stderr redirect suffix: 2>nul on Windows, 2>/dev/null on Unix -->
  <PropertyGroup>
    <_StderrRedirect Condition="'$(OS)' == 'Windows_NT'"> 2^&gt;nul</_StderrRedirect>
    <_StderrRedirect Condition="'$(OS)' != 'Windows_NT'"> 2&gt;/dev/null</_StderrRedirect>
  </PropertyGroup>

  <Target Name="_ANcpLuaComputeGitMetadata" BeforeTargets="InitializeSourceControlInformation;GenerateNuspec">
    <Exec Command="git -C &quot;$(MSBuildProjectDirectory)&quot; rev-parse --show-toplevel$(_StderrRedirect)"
          ConsoleToMSBuild="true"
          IgnoreExitCode="true"
          StandardOutputImportance="Low"
          StandardErrorImportance="Low">
      <Output TaskParameter="ConsoleOutput" PropertyName="_GitRootFromGit"/>
    </Exec>

    <PropertyGroup>
      <_GitRoot Condition="'$(_GitRoot)' == '' and '$(_GitRootFromGit)' != ''">$([System.String]::Copy('$(_GitRootFromGit)').Trim())</_GitRoot>
      <_ANcpLuaInGitRepo Condition="'$(_GitRoot)' != ''">true</_ANcpLuaInGitRepo>
      <_ANcpLuaInGitRepo Condition="'$(_GitRoot)' == ''">false</_ANcpLuaInGitRepo>
    </PropertyGroup>

    <PropertyGroup Condition="'$(_ANcpLuaInGitRepo)' == 'false'">
      <EnableSourceControlManagerQueries>false</EnableSourceControlManagerQueries>
      <EnableSourceLink>false</EnableSourceLink>
      <!-- NETSDK1018: Duplicate PackageReference - occurs in non-git temp folders during pack -->
      <NoWarn>$(NoWarn);NETSDK1018</NoWarn>
    </PropertyGroup>

    <Exec Command="git -C &quot;$(_GitRoot)&quot; config --get remote.origin.url$(_StderrRedirect)"
          ConsoleToMSBuild="true"
          IgnoreExitCode="true"
          StandardOutputImportance="Low"
          StandardErrorImportance="Low"
          Condition="'$(_ANcpLuaInGitRepo)' == 'true'">
      <Output TaskParameter="ConsoleOutput" PropertyName="_GitOriginUrlRaw"/>
    </Exec>

    <Exec Command="git -C &quot;$(_GitRoot)&quot; symbolic-ref --quiet HEAD$(_StderrRedirect)"
          ConsoleToMSBuild="true"
          IgnoreExitCode="true"
          StandardOutputImportance="Low"
          StandardErrorImportance="Low"
          Condition="'$(_ANcpLuaInGitRepo)' == 'true'">
      <Output TaskParameter="ConsoleOutput" PropertyName="_GitBranchRefRaw"/>
    </Exec>

    <Exec Command="git -C &quot;$(_GitRoot)&quot; rev-parse --abbrev-ref HEAD$(_StderrRedirect)"
          ConsoleToMSBuild="true"
          IgnoreExitCode="true"
          StandardOutputImportance="Low"
          StandardErrorImportance="Low"
          Condition="'$(_ANcpLuaInGitRepo)' == 'true' and '$(_GitBranchRefRaw)' == ''">
      <Output TaskParameter="ConsoleOutput" PropertyName="_GitBranchNameRaw"/>
    </Exec>

    <Exec Command="git -C &quot;$(_GitRoot)&quot; rev-parse HEAD$(_StderrRedirect)"
          ConsoleToMSBuild="true"
          IgnoreExitCode="true"
          StandardOutputImportance="Low"
          StandardErrorImportance="Low"
          Condition="'$(_ANcpLuaInGitRepo)' == 'true'">
      <Output TaskParameter="ConsoleOutput" PropertyName="_GitCommitRaw"/>
    </Exec>

    <PropertyGroup Condition="'$(_ANcpLuaInGitRepo)' == 'true'">
      <EnableSourceControlManagerQueries>true</EnableSourceControlManagerQueries>
      <EnableSourceLink Condition="'$(EnableSourceLink)' == ''">true</EnableSourceLink>
      <PublishRepositoryUrl>true</PublishRepositoryUrl>

      <RepositoryType Condition="'$(RepositoryType)' == ''">git</RepositoryType>
      <RepositoryUrl Condition="'$(RepositoryUrl)' == '' and '$(_GitOriginUrlRaw)' != ''">$([System.String]::Copy('$(_GitOriginUrlRaw)').Trim())</RepositoryUrl>

      <_GitBranchRef>$([System.String]::Copy('$(_GitBranchRefRaw)').Trim())</_GitBranchRef>
      <_GitBranchName Condition="'$(_GitBranchNameRaw)' != ''">$([System.String]::Copy('$(_GitBranchNameRaw)').Trim())</_GitBranchName>

      <RepositoryBranch Condition="'$(RepositoryBranch)' == '' and '$(_GitBranchRef)' != ''">$(_GitBranchRef)</RepositoryBranch>
      <RepositoryBranch Condition="'$(RepositoryBranch)' == '' and '$(_GitBranchRef)' == '' and '$(_GitBranchName)' != ''">refs/heads/$(_GitBranchName)</RepositoryBranch>
      <RepositoryCommit Condition="'$(RepositoryCommit)' == '' and '$(_GitCommitRaw)' != ''">$([System.String]::Copy('$(_GitCommitRaw)').Trim())</RepositoryCommit>
    </PropertyGroup>
  </Target>

  <Target Name="_ANcpLuaCopyRepositoryMetadata"
          AfterTargets="InitializeSourceControlInformation"
          Condition="'$(_ANcpLuaInGitRepo)' == 'true'">
    <PropertyGroup>
      <RepositoryUrl Condition="'$(RepositoryUrl)' == '' and '$(ScmRepositoryUrl)' != ''">$(ScmRepositoryUrl)</RepositoryUrl>
      <RepositoryType Condition="'$(RepositoryType)' == '' and '$(ScmRepositoryUrl)' != ''">git</RepositoryType>
    </PropertyGroup>
  </Target>
</Project>