<Project>
  <!--
    ═══════════════════════════════════════════════════════════════════════════
    ADVANCED ITEM METADATA (Phase 2)
    ═══════════════════════════════════════════════════════════════════════════

    NOTE: Avoid using %(Metadata) in Condition attributes for metadata that may
    not exist on all items - this causes MSB4096. Instead, set metadata with
    inner Condition on the metadata element itself.
  -->

  <!-- Auto-set Link for files outside project directory -->
  <Target Name="_SetLinkMetadataForExternalFiles"
          BeforeTargets="AssignTargetPaths">
    <ItemGroup>
      <!-- Only update Compile items that are outside the project directory -->
      <Compile Update="@(Compile)"
               Condition="!$([System.String]::new('%(FullPath)').StartsWith('$(MSBuildProjectDirectory)'))">
        <Link Condition="'%(Compile.Link)' == ''">External\%(Filename)%(Extension)</Link>
      </Compile>
    </ItemGroup>
  </Target>

  <!-- Auto-mark generated files -->
  <Target Name="_MarkGeneratedFiles"
          BeforeTargets="CoreCompile">
    <ItemGroup>
      <Compile Update="@(Compile)"
               Condition="$([System.String]::new('%(FullPath)').Contains('obj')) Or
                          $([System.String]::new('%(Filename)').Contains('.g.')) Or
                          $([System.String]::new('%(Filename)').Contains('.generated'))">
        <AutoGen>true</AutoGen>
        <Visible>false</Visible>
      </Compile>
    </ItemGroup>
  </Target>

  <!-- Auto-set DependentUpon for common patterns -->
  <Target Name="_SetDependentUponMetadata"
          BeforeTargets="AssignTargetPaths"
          Condition="'$(DisableAutoDependentUpon)' != 'true'">
    <ItemGroup>
      <!-- *.Designer.cs depends on *.resx -->
      <Compile Update="@(Compile)"
               Condition="$([System.String]::new('%(Filename)').EndsWith('.Designer'))">
        <DependentUpon Condition="'%(Compile.DependentUpon)' == ''">$([System.String]::new('%(Filename)').Replace('.Designer', '')).resx</DependentUpon>
      </Compile>

      <!-- *.g.cs depends on *.xaml -->
      <Compile Update="@(Compile)"
               Condition="$([System.String]::new('%(Filename)').EndsWith('.g'))">
        <DependentUpon Condition="'%(Compile.DependentUpon)' == ''">$([System.String]::new('%(Filename)').Replace('.g', '')).xaml</DependentUpon>
        <AutoGen>true</AutoGen>
      </Compile>
    </ItemGroup>
  </Target>

  <!-- Assembly metadata injection -->
  <ItemGroup>
    <AssemblyMetadata Include="SDKVersion" Value="$(ANcpSdkPackageVersion)" />
    <AssemblyMetadata Include="RepositoryCommit" Value="$(SourceRevisionId)" Condition="'$(SourceRevisionId)' != ''" />
  </ItemGroup>
</Project>
