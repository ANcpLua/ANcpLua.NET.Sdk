<Project>
  <PropertyGroup>
    <IsPackable>false</IsPackable>
  </PropertyGroup>

  <!-- ═══════════════════════════════════════════════════════════════════════
       TEST FRAMEWORK INJECTION
       Auto-inject AwesomeAssertions (always) and xUnit v3 MTP (unless skipped)
       ═══════════════════════════════════════════════════════════════════════ -->

  <!-- AwesomeAssertions is useful for any test framework (always injected) -->
  <ItemGroup>
    <PackageReference Include="AwesomeAssertions" Version="$(AwesomeAssertionsVersion)" VersionOverride="$(AwesomeAssertionsVersion)" IsImplicitlyDefined="true"/>
  </ItemGroup>

  <ItemGroup Condition="'$(ImplicitUsings)' == 'enable'">
    <Using Include="AwesomeAssertions"/>
  </ItemGroup>

  <!-- Auto-inject xUnit v3 MTP (target-based so SkipXunitInjection auto-detection works) -->
  <Target Name="_InjectTestFrameworkPackages"
          BeforeTargets="BeforeBuild;Restore;CollectPackageReferences"
          DependsOnTargets="_DetectTestFrameworksAndMTP"
          Condition="'$(SkipXunitInjection)' != 'true'">
    <!-- Check if xUnit is already present (user-supplied or from another source) -->
    <ItemGroup>
      <_ExistingXunit Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit.v3' OR '%(Identity)' == 'xunit.v3.mtp-v1' OR '%(Identity)' == 'xunit.v3.mtp-v2' OR '%(Identity)' == 'xunit.v3.mtp-off'"/>
    </ItemGroup>
    <!-- Only inject if not already present (avoids NETSDK1023 duplicate warning) -->
    <ItemGroup Condition="'@(_ExistingXunit)' == ''">
      <PackageReference Include="xunit.v3.mtp-v2" Version="$(XunitMtpVersion)" VersionOverride="$(XunitMtpVersion)" IsImplicitlyDefined="true"/>
    </ItemGroup>
    <!-- Configure MTP properties since we're injecting xUnit MTP -->
    <PropertyGroup>
      <_UsesMTP>true</_UsesMTP>
      <_UsesXunitV3Mtp>true</_UsesXunitV3Mtp>
      <UseMicrosoftTestingPlatform Condition="'$(UseMicrosoftTestingPlatform)' == ''">true</UseMicrosoftTestingPlatform>
      <!-- Only auto-set OutputType if user didn't explicitly enable MTP (let safety guard warn instead) -->
      <OutputType Condition="'$(OutputType)' == 'Library' AND '$(_MTPExplicitlySet)' != 'true'">Exe</OutputType>
      <TestingPlatformDotnetTestSupport Condition="'$(TestingPlatformDotnetTestSupport)' == ''">true</TestingPlatformDotnetTestSupport>
      <TestingPlatformCommandLineArguments Condition="'$(TestingPlatformCommandLineArguments)' == ''">--report-xunit-trx</TestingPlatformCommandLineArguments>
    </PropertyGroup>
  </Target>

  <!-- Add implicit using for xunit (via Target for correct timing - items require Target) -->
  <Target Name="_InjectXunitUsings" BeforeTargets="BeforeBuild;CollectPackageReferences" DependsOnTargets="_DetectTestFrameworksAndMTP;_InjectTestFrameworkPackages" Condition="'$(ImplicitUsings)' == 'enable'">
    <!-- Filter xUnit packages using correct MSBuild syntax -->
    <ItemGroup>
      <_XunitUsings Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit'"/>
      <_XunitUsings Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit.v3'"/>
      <_XunitUsings Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit.v3.mtp-v1'"/>
      <_XunitUsings Include="@(PackageReference)" Condition="'%(Identity)' == 'xunit.v3.mtp-v2'"/>
    </ItemGroup>
    <ItemGroup Condition="'@(_XunitUsings)' != ''">
      <Using Include="Xunit"/>
    </ItemGroup>
  </Target>

  <!-- ═══════════════════════════════════════════════════════════════════════
       TEST EXTENSIONS (Auto-injected for test projects)
       ═══════════════════════════════════════════════════════════════════════ -->

  <!-- GitHub Actions Test Reporting (via Target for correct timing) -->
  <Target Name="_InjectGitHubActionsLogger" BeforeTargets="BeforeBuild;Restore;CollectPackageReferences" DependsOnTargets="_DetectTestFrameworksAndMTP" Condition="'$(_IsGitHubActions)' == 'true'">
    <!-- MTP: GitHubActionsTestLogger auto-registers -->
    <ItemGroup>
      <PackageReference Include="GitHubActionsTestLogger" Version="$(GitHubActionsLoggerMTPVersion)" VersionOverride="$(GitHubActionsLoggerMTPVersion)" IsImplicitlyDefined="true"/>
    </ItemGroup>
  </Target>

</Project>