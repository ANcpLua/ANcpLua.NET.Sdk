<!--
  LegacySupport.targets - Polyfill and extension injection via NuGet packages

  All polyfills and extensions are now sourced from NuGet packages:
  - ANcpLua.Roslyn.Utilities.Polyfills (source-only polyfills with #if guards)
  - ANcpLua.Roslyn.Utilities.Sources (source-only Roslyn utilities)

  The InjectXxx properties control what gets injected. The Polyfills package
  uses opt-out (removes polyfills when InjectXxx=false). The Sources package
  is all-or-nothing.
-->
<Project>
  <!-- ═══════════════════════════════════════════════════════════════════════
       BUNDLE EXPANSION
       Must be in .targets to run AFTER project PropertyGroups set their values.
       This allows user to set InjectAllPolyfillsOnLegacy=true in their project.
       ═══════════════════════════════════════════════════════════════════════ -->
  <PropertyGroup Condition="'$(InjectAllPolyfillsOnLegacy)' == 'true'">
    <InjectTrimAttributesOnLegacy>true</InjectTrimAttributesOnLegacy>
    <InjectNullabilityAttributesOnLegacy>true</InjectNullabilityAttributesOnLegacy>
    <InjectIsExternalInitOnLegacy>true</InjectIsExternalInitOnLegacy>
    <InjectRequiredMemberOnLegacy>true</InjectRequiredMemberOnLegacy>
    <InjectSetsRequiredMembersOnLegacy>true</InjectSetsRequiredMembersOnLegacy>
    <InjectCallerAttributesOnLegacy>true</InjectCallerAttributesOnLegacy>
    <InjectCompilerFeatureRequiredOnLegacy>true</InjectCompilerFeatureRequiredOnLegacy>
    <InjectUnreachableExceptionOnLegacy>true</InjectUnreachableExceptionOnLegacy>
    <InjectExperimentalAttributeOnLegacy>true</InjectExperimentalAttributeOnLegacy>
    <InjectIndexRangeOnLegacy>true</InjectIndexRangeOnLegacy>
    <InjectStackTraceHiddenOnLegacy>true</InjectStackTraceHiddenOnLegacy>
    <InjectLockPolyfill>true</InjectLockPolyfill>
    <InjectTimeProviderPolyfill>true</InjectTimeProviderPolyfill>
    <InjectStringExtensionsPolyfill>true</InjectStringExtensionsPolyfill>
    <InjectANcpLuaDiagnosticsPolyfills>true</InjectANcpLuaDiagnosticsPolyfills>
    <InjectANcpLuaExceptionPolyfills>true</InjectANcpLuaExceptionPolyfills>
    <InjectANcpLuaExperimentalPolyfills>true</InjectANcpLuaExperimentalPolyfills>
    <InjectANcpLuaIndexRangePolyfills>true</InjectANcpLuaIndexRangePolyfills>
    <InjectANcpLuaLanguageFeaturesPolyfills>true</InjectANcpLuaLanguageFeaturesPolyfills>
    <InjectANcpLuaNullabilityPolyfills>true</InjectANcpLuaNullabilityPolyfills>
    <InjectANcpLuaTimeProviderPolyfill>true</InjectANcpLuaTimeProviderPolyfill>
    <InjectANcpLuaTrimAttributesPolyfills>true</InjectANcpLuaTrimAttributesPolyfills>
    <InjectDiagnosticClassesOnLegacy>true</InjectDiagnosticClassesOnLegacy>
  </PropertyGroup>

  <PropertyGroup Condition="'$(InjectAllExtensions)' == 'true'">
    <InjectSourceGenHelpers>true</InjectSourceGenHelpers>
    <InjectCommonComparers>true</InjectCommonComparers>
  </PropertyGroup>

  <!-- InjectAllLanguageFeaturePolyfills - All C# 14 language feature polyfills for netstandard2.0 -->
  <PropertyGroup Condition="'$(InjectAllLanguageFeaturePolyfills)' == 'true'">
    <InjectIsExternalInitOnLegacy>true</InjectIsExternalInitOnLegacy>
    <InjectRequiredMemberOnLegacy>true</InjectRequiredMemberOnLegacy>
    <InjectSetsRequiredMembersOnLegacy>true</InjectSetsRequiredMembersOnLegacy>
    <InjectCallerAttributesOnLegacy>true</InjectCallerAttributesOnLegacy>
    <InjectCompilerFeatureRequiredOnLegacy>true</InjectCompilerFeatureRequiredOnLegacy>
    <InjectParamCollectionOnLegacy>true</InjectParamCollectionOnLegacy>
    <InjectIndexRangeOnLegacy>true</InjectIndexRangeOnLegacy>
    <InjectNullabilityAttributesOnLegacy>true</InjectNullabilityAttributesOnLegacy>
  </PropertyGroup>

  <!-- ═══════════════════════════════════════════════════════════════════════
       DETECT IF ANY POLYFILL IS NEEDED
       ═══════════════════════════════════════════════════════════════════════ -->
  <PropertyGroup>
    <_NeedsPolyfillsPackage>false</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectAllPolyfillsOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectAllLanguageFeaturePolyfills)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectTrimAttributesOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectNullabilityAttributesOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectIsExternalInitOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectRequiredMemberOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectCallerAttributesOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectCompilerFeatureRequiredOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectSetsRequiredMembersOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectUnreachableExceptionOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectExperimentalAttributeOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectIndexRangeOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectStackTraceHiddenOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectLockPolyfill)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectTimeProviderPolyfill)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectStringExtensionsPolyfill)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectANcpLuaLanguageFeaturesPolyfills)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectANcpLuaTrimAttributesPolyfills)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectANcpLuaNullabilityPolyfills)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectANcpLuaDiagnosticsPolyfills)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectANcpLuaExceptionPolyfills)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectANcpLuaExperimentalPolyfills)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectANcpLuaIndexRangePolyfills)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectANcpLuaTimeProviderPolyfill)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectDiagnosticClassesOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
    <_NeedsPolyfillsPackage Condition="'$(InjectParamCollectionOnLegacy)' == 'true'">true</_NeedsPolyfillsPackage>
  </PropertyGroup>

  <!-- ═══════════════════════════════════════════════════════════════════════
       POLYFILLS via NuGet: ANcpLua.Roslyn.Utilities.Polyfills
       Source-only package with #if guards. The package's own build/targets
       handle opt-out via the same InjectXxx properties.
       ═══════════════════════════════════════════════════════════════════════ -->
  <ItemGroup Condition="'$(_NeedsPolyfillsPackage)' == 'true'">
    <PackageReference Include="ANcpLua.Roslyn.Utilities.Polyfills" Version="$(ANcpLuaRoslynUtilitiesPolyfillsVersion)" VersionOverride="$(ANcpLuaRoslynUtilitiesPolyfillsVersion)" PrivateAssets="all" IsImplicitlyDefined="true"/>
  </ItemGroup>

  <!-- TimeProvider on legacy frameworks requires IAsyncDisposable and ValueTask -->
  <ItemGroup Condition="('$(InjectTimeProviderPolyfill)' == 'true' OR '$(InjectANcpLuaTimeProviderPolyfill)' == 'true') AND ('$(TargetFramework)' == 'netstandard2.0' OR '$(TargetFramework)' == 'net462')">
    <PackageReference Include="Microsoft.Bcl.AsyncInterfaces" Version="$(BclAsyncInterfacesVersion)" VersionOverride="$(BclAsyncInterfacesVersion)" Condition="'$(TargetFramework)' == 'netstandard2.0' or '$(TargetFramework)' == 'net462'"/>
    <PackageReference Include="System.Threading.Tasks.Extensions" Version="$(TasksExtensionsVersion)" VersionOverride="$(TasksExtensionsVersion)" Condition="'$(TargetFramework)' == 'netstandard2.0' or '$(TargetFramework)' == 'net462'"/>
  </ItemGroup>

  <!-- ═══════════════════════════════════════════════════════════════════════
       EXTENSIONS via NuGet: ANcpLua.Roslyn.Utilities.Sources
       Source-only package containing all Roslyn utilities as internal types.
       Covers: EquatableArray, DiagnosticInfo, DiagnosticAnalyzerBase,
       CodeFixProviderBase, SyntaxModifierExtensions, StringOrdinalComparer, etc.
       ═══════════════════════════════════════════════════════════════════════ -->
  <ItemGroup Condition="'$(InjectSourceGenHelpers)' == 'true' OR '$(InjectCodeFixProviderBase)' == 'true' OR '$(InjectDiagnosticAnalyzerBase)' == 'true' OR '$(InjectSyntaxModifierExtensions)' == 'true' OR '$(InjectCommonComparers)' == 'true' OR '$(InjectStringOrdinalComparer)' == 'true'">
    <PackageReference Include="ANcpLua.Roslyn.Utilities.Sources" Version="$(ANcpLuaRoslynUtilitiesSourcesVersion)" VersionOverride="$(ANcpLuaRoslynUtilitiesSourcesVersion)" PrivateAssets="all" IsImplicitlyDefined="true"/>
  </ItemGroup>

</Project>
