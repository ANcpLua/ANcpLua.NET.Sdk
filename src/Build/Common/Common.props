<Project>
  <!-- Guard to prevent double-import (MSB4011) -->
  <PropertyGroup>
    <_ANcpLuaCommonPropsImported>true</_ANcpLuaCommonPropsImported>
  </PropertyGroup>

  <Import Project="$(MSBuildThisFileDirectory)/ContinuousIntegrationBuild.props"/>
  <Import Project="$(MSBuildThisFileDirectory)/LegacySupport.props"/>
  <Import Project="$(MSBuildThisFileDirectory)/SourceGenerators.props"/>

  <PropertyGroup Label="Git Detection">
    <_ANcpLuaGitDir Condition="'$(_ANcpLuaGitDir)' == ''">$([MSBuild]::GetDirectoryNameOfFileAbove('$(MSBuildProjectDirectory)', '.git'))</_ANcpLuaGitDir>
    <_ANcpLuaInGitRepo Condition="'$(_ANcpLuaGitDir)' != ''">true</_ANcpLuaInGitRepo>
    <_ANcpLuaInGitRepo Condition="'$(_ANcpLuaInGitRepo)' == ''">false</_ANcpLuaInGitRepo>
  </PropertyGroup>

  <PropertyGroup Condition="'$(_ANcpLuaInGitRepo)' != 'true'">
    <EnableSourceLink>false</EnableSourceLink>
    <EnableSourceControlManagerQueries>false</EnableSourceControlManagerQueries>
    <!-- Don't set PublishRepositoryUrl to false - let default (true) apply -->
  </PropertyGroup>

  <PropertyGroup>
    <SuppressNETCoreSdkPreviewMessage>true</SuppressNETCoreSdkPreviewMessage>
    <_IsANcpLuaProject>$(MSBuildProjectName.StartsWith('ANcpLua', StringComparison.OrdinalIgnoreCase))</_IsANcpLuaProject>

    <!-- SDK Defaults - inject essential shared code -->
    <InjectSharedThrow Condition="'$(InjectSharedThrow)' == ''">true</InjectSharedThrow>
    <GenerateClaudeMd Condition="'$(GenerateClaudeMd)' == ''">true</GenerateClaudeMd>
  </PropertyGroup>

  <!-- Enable interceptors for ASP.NET Core projects (OpenAPI generator) -->
  <PropertyGroup Condition="'$(UsingMicrosoftNETSdkWeb)' == 'true'">
    <InterceptorsNamespaces>$(InterceptorsNamespaces);Microsoft.AspNetCore.OpenApi.Generated</InterceptorsNamespaces>
  </PropertyGroup>

  <PropertyGroup>
    <!-- Publish the repository URL in the built .nupkg (in the NuSpec <Repository> element) -->
    <PublishRepositoryUrl Condition="'$(PublishRepositoryUrl)' == ''">true</PublishRepositoryUrl>

    <!-- DebugType is set in DeterminismAndSourceLink.props (portable + snupkg) -->
    <!-- Embed source files that are not tracked by the source control manager in the PDB -->
    <EmbedUntrackedSources Condition="'$(EmbedUntrackedSources)' == ''">true</EmbedUntrackedSources>
    <IncludeSourceRevisionInInformationalVersion Condition="'$(IncludeSourceRevisionInInformationalVersion)' == ''">true</IncludeSourceRevisionInInformationalVersion>
    <!-- Only enable if we're in a git repo - see _ANcpLuaInGitRepo detection above -->
    <EnableSourceControlManagerQueries Condition="'$(EnableSourceControlManagerQueries)' == '' and '$(_ANcpLuaInGitRepo)' == 'true'">true</EnableSourceControlManagerQueries>
    <EnableSourceLink Condition="'$(EnableSourceLink)' == '' and '$(_ANcpLuaInGitRepo)' == 'true'">true</EnableSourceLink>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>

    <GenerateDocumentationFile>true</GenerateDocumentationFile>

    <!--
        Disabling static graph restore due to a bug related to NuGetAuditSuppress.
        See: https://github.com/NuGet/Home/issues/14300
      -->
    <RestoreUseStaticGraphEvaluation>false</RestoreUseStaticGraphEvaluation>
    <RestoreSerializeGlobalProperties>true</RestoreSerializeGlobalProperties>

    <ReportAnalyzer>true</ReportAnalyzer>
    <Features>strict</Features>
    <Deterministic>true</Deterministic>
    <EnableNETAnalyzers>true</EnableNETAnalyzers>
    <AnalysisLevel>latest-all</AnalysisLevel>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <LangVersion Condition="'$(LangVersion)' == ''">latest</LangVersion>
    <MSBuildTreatWarningsAsErrors Condition="'$(ContinuousIntegrationBuild)' == 'true' OR '$(Configuration)' == 'Release'">true</MSBuildTreatWarningsAsErrors>
    <TreatWarningsAsErrors Condition="'$(ContinuousIntegrationBuild)' == 'true' OR '$(Configuration)' == 'Release'">true</TreatWarningsAsErrors>
    <EnforceCodeStyleInBuild Condition="'$(ContinuousIntegrationBuild)' == 'true' OR '$(Configuration)' == 'Release'">true</EnforceCodeStyleInBuild>

    <EnablePackageValidation Condition="'$(EnablePackageValidation)' == ''">true</EnablePackageValidation>
    <ManagePackageVersionsCentrally Condition="'$(ManagePackageVersionsCentrally)' == ''">true</ManagePackageVersionsCentrally>
    <CentralPackageTransitivePinningEnabled Condition="'$(CentralPackageTransitivePinningEnabled)' == ''">true</CentralPackageTransitivePinningEnabled>
  </PropertyGroup>

  <ItemDefinitionGroup>
    <PackageReference>
      <PrivateAssets></PrivateAssets>
    </PackageReference>
  </ItemDefinitionGroup>

  <PropertyGroup Label="NuGet Audit">
    <NuGetAudit>true</NuGetAudit>
    <NuGetAuditMode>all</NuGetAuditMode>
    <NuGetAuditLevel>low</NuGetAuditLevel>
    <WarningsAsErrors Condition="'$(ContinuousIntegrationBuild)' == 'true' OR '$(Configuration)' == 'Release'">$(WarningsAsErrors);NU1900;NU1901;NU1902;NU1903;NU1904</WarningsAsErrors>
  </PropertyGroup>

  <PropertyGroup>
    <AccelerateBuildsInVisualStudio>true</AccelerateBuildsInVisualStudio>
  </PropertyGroup>

  <!-- NOTE: Microsoft.SourceLink.GitHub is NOT injected here.
       .NET 8+ includes SourceLink by default. Since this SDK requires .NET 10+,
       SourceLink is always available without a package reference. -->

  <!-- Opt-in: ANcpLua.Roslyn.Utilities (core Roslyn helpers)
       Enable with: <UseRoslynUtilities>true</UseRoslynUtilities>

       Provides: EquatableArray<T>, DiagnosticInfo, DiagnosticFlow<T>,
                 AwaitableContext, CollectionContext, symbol extensions

       For netstandard2.0 (generators): uses .Sources package (bundled in output)
       For net10.0+ (runtime): uses regular package reference -->
  <ItemGroup Condition="'$(UseRoslynUtilities)' == 'true' and '$(TargetFrameworkIdentifier)' != '.NETStandard'">
    <PackageReference Include="ANcpLua.Roslyn.Utilities" Version="$(ANcpLuaRoslynUtilitiesVersion)" VersionOverride="$(ANcpLuaRoslynUtilitiesVersion)"/>
  </ItemGroup>
  <ItemGroup Condition="'$(UseRoslynUtilities)' == 'true' and '$(TargetFrameworkIdentifier)' == '.NETStandard'">
    <PackageReference Include="ANcpLua.Roslyn.Utilities.Sources" Version="$(ANcpLuaRoslynUtilitiesSourcesVersion)" VersionOverride="$(ANcpLuaRoslynUtilitiesSourcesVersion)" PrivateAssets="all"/>
  </ItemGroup>

  <!-- GlobalUsings for Roslyn utilities (when opted-in, non-netstandard only) -->
  <ItemGroup Condition="'$(UseRoslynUtilities)' == 'true' and '$(ImplicitUsings)' == 'enable' and '$(TargetFrameworkIdentifier)' != '.NETStandard'">
    <Using Include="ANcpLua.Roslyn.Utilities"/>
  </ItemGroup>

  <ItemGroup>
    <!-- Shared injected test bases are packaged, not compiled (hidden from Solution Explorer) -->
    <Compile Remove="$(MSBuildThisFileDirectory)../../Testing/Fixtures/*.cs"/>
    <None Include="$(MSBuildThisFileDirectory)../../Testing/Fixtures/*.cs" Pack="false" Visible="false"/>

    <!-- Add all editorconfig files (hidden from Solution Explorer) -->
    <EditorConfigFiles Include="$(MSBuildThisFileDirectory)../../Config/*.editorconfig" Visible="false"/>
  </ItemGroup>

</Project>