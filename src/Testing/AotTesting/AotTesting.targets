<?xml version="1.0" encoding="utf-8"?>
<!--
  AOT/Trim Testing Orchestration Targets

  DESIGN:
  This file provides the orchestration logic for discovering and running AOT (Ahead-of-Time)
  and trimming tests within the xUnit v3 MTP test framework. The implementation follows a
  staged approach:

  1. DISCOVERY (_DiscoverAotTests):
     - Uses reflection to scan the test assembly for methods with [AotTest] or [TrimTest] attributes
     - Creates AotTestItem items with metadata: MethodName, TypeName, IsAot, IsTrim, etc.

  2. PROJECT GENERATION (_GenerateAotTestProjects):
     - For each discovered test, creates a temporary project directory
     - Applies ProjectTemplate.csproj.txt and Directory.Build.props.txt
     - Generates a Program.cs that invokes the test method

  3. PUBLISH (_PublishAotTests):
     - Runs 'dotnet publish' on each generated project
     - Applies PublishAot=true or PublishTrimmed=true as appropriate

  4. EXECUTION (_ExecuteAotTests):
     - Runs each published executable
     - Validates exit code 100 (reserved for AOT/Trim test success)

  5. REPORTING (_ReportAotTestResults):
     - Aggregates results and reports summary
     - Fails the build if any test fails

  6. CLEANUP (_CleanAotTests):
     - Removes temporary AOT test projects and artifacts
-->

<Project>

  <!-- ================================================================
       PROPERTY DEFINITIONS
       ================================================================ -->

  <PropertyGroup>
    <!-- Directory containing AOT testing infrastructure templates -->
    <_AotTestTemplateDir>$(MSBuildThisFileDirectory)</_AotTestTemplateDir>

    <!-- Project template for generating temporary AOT test projects -->
    <_AotTestProjectTemplate>$(_AotTestTemplateDir)ProjectTemplate.csproj.txt</_AotTestProjectTemplate>

    <!-- Directory.Build.props template with AOT/Trim configuration -->
    <_AotTestDirBuildProps>$(_AotTestTemplateDir)Directory.Build.props.txt</_AotTestDirBuildProps>

    <!-- Directory where temporary AOT test projects will be generated -->
    <AotTestProjectsDir Condition="'$(AotTestProjectsDir)' == ''">$(IntermediateOutputPath)AotTests</AotTestProjectsDir>

    <!-- Platform detection -->
    <_CurrentOsName Condition="$([MSBuild]::IsOSPlatform('Windows'))">win</_CurrentOsName>
    <_CurrentOsName Condition="$([MSBuild]::IsOSPlatform('OSX'))">osx</_CurrentOsName>
    <_CurrentOsName Condition="$([MSBuild]::IsOSPlatform('Linux'))">linux</_CurrentOsName>

    <!-- Architecture detection (always use actual OS architecture, not $(Platform) which is typically AnyCPU) -->
    <_RawArchitecture>$([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture.ToString().ToLowerInvariant())</_RawArchitecture>
    <_CurrentArchitecture Condition="'$(_RawArchitecture)' == 'x86'">x86</_CurrentArchitecture>
    <_CurrentArchitecture Condition="'$(_RawArchitecture)' == 'x64' or '$(_RawArchitecture)' == 'amd64'">x64</_CurrentArchitecture>
    <_CurrentArchitecture Condition="'$(_RawArchitecture)' == 'arm'">arm</_CurrentArchitecture>
    <_CurrentArchitecture Condition="'$(_RawArchitecture)' == 'arm64'">arm64</_CurrentArchitecture>
    <_CurrentArchitecture Condition="'$(_CurrentArchitecture)' == ''">$(_RawArchitecture)</_CurrentArchitecture>

    <!-- Default RID -->
    <_DefaultRuntimeIdentifier>$(_CurrentOsName)-$(_CurrentArchitecture)</_DefaultRuntimeIdentifier>

    <!-- Test assembly path (must be absolute for generated projects to reference correctly) -->
    <_TestAssemblyPath Condition="$([System.IO.Path]::IsPathRooted('$(TargetPath)'))">$(TargetPath)</_TestAssemblyPath>
    <_TestAssemblyPath Condition="!$([System.IO.Path]::IsPathRooted('$(TargetPath)'))">$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)\$(TargetPath)'))</_TestAssemblyPath>
  </PropertyGroup>

  <!-- ================================================================
       INLINE TASK: DISCOVER AOT TESTS
       Uses reflection to find [AotTest] and [TrimTest] methods
       ================================================================ -->

  <UsingTask TaskName="DiscoverAotTestsTask"
             TaskFactory="RoslynCodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <TestAssemblyPath ParameterType="System.String" Required="true" />
      <DefaultRuntimeIdentifier ParameterType="System.String" Required="true" />
      <CurrentOsName ParameterType="System.String" Required="true" />
      <DiscoveredTests ParameterType="Microsoft.Build.Framework.ITaskItem[]" Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System" />
      <Using Namespace="System.Reflection" />
      <Using Namespace="System.Collections.Generic" />
      <Using Namespace="System.IO" />
      <Using Namespace="Microsoft.Build.Framework" />
      <Using Namespace="Microsoft.Build.Utilities" />
      <Code Type="Fragment" Language="cs">
<![CDATA[
var discoveredTests = new List<ITaskItem>();

if (!File.Exists(TestAssemblyPath))
{
    Log.LogWarning($"Test assembly not found: {TestAssemblyPath}");
    DiscoveredTests = discoveredTests.ToArray();
    return true;
}

try
{
    // Load the test assembly
    var assembly = Assembly.LoadFrom(TestAssemblyPath);

    // Find all types in the assembly
    Type[] types;
    try
    {
        types = assembly.GetTypes();
    }
    catch (ReflectionTypeLoadException ex)
    {
        types = ex.Types.Where(t => t != null).ToArray();
    }

    int testIndex = 0;

    foreach (var type in types)
    {
        if (type == null) continue;

        // Get all methods
        var methods = type.GetMethods(BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Static | BindingFlags.Instance);

        foreach (var method in methods)
        {
            // Check for [AotTest] attribute
            var aotTestAttr = method.GetCustomAttributes(false)
                .FirstOrDefault(a => a.GetType().Name == "AotTestAttribute");

            // Check for [TrimTest] attribute
            var trimTestAttr = method.GetCustomAttributes(false)
                .FirstOrDefault(a => a.GetType().Name == "TrimTestAttribute");

            if (aotTestAttr == null && trimTestAttr == null)
                continue;

            // Validate return type
            if (method.ReturnType != typeof(int))
            {
                Log.LogWarning($"Skipping {type.FullName}.{method.Name}: AOT/Trim test methods must return int");
                continue;
            }

            var attrToUse = aotTestAttr ?? trimTestAttr;
            var attrType = attrToUse.GetType();

            // Extract attribute properties using reflection
            string skipOnPlatform = attrType.GetProperty("SkipOnPlatform")?.GetValue(attrToUse) as string;
            string runtimeIdentifier = attrType.GetProperty("RuntimeIdentifier")?.GetValue(attrToUse) as string;
            string[] disabledSwitches = attrType.GetProperty("DisabledFeatureSwitches")?.GetValue(attrToUse) as string[];
            string configuration = (attrType.GetProperty("Configuration")?.GetValue(attrToUse) as string) ?? "Release";
            int timeoutSeconds = (int)(attrType.GetProperty("TimeoutSeconds")?.GetValue(attrToUse) ?? 300);

            // Check if we should skip on current platform
            if (!string.IsNullOrEmpty(skipOnPlatform) &&
                skipOnPlatform.Equals(CurrentOsName, StringComparison.OrdinalIgnoreCase))
            {
                Log.LogMessage(MessageImportance.Normal,
                    $"Skipping {type.FullName}.{method.Name}: platform {CurrentOsName} is excluded");
                continue;
            }

            // Determine RID
            if (string.IsNullOrEmpty(runtimeIdentifier))
            {
                runtimeIdentifier = DefaultRuntimeIdentifier;
            }

            // Extract TrimMode for [TrimTest] (must be lowercase for ILLink)
            string trimMode = "full";
            if (trimTestAttr != null)
            {
                var trimModeValue = attrType.GetProperty("TrimMode")?.GetValue(attrToUse);
                if (trimModeValue != null)
                {
                    // Convert to lowercase (ILLink expects "full" or "partial", not "Full" or "Partial")
                    trimMode = trimModeValue.ToString().ToLowerInvariant();
                }
            }

            // Create test item
            var testItem = new TaskItem($"AotTest_{testIndex++}");
            testItem.SetMetadata("MethodName", method.Name);
            testItem.SetMetadata("TypeName", type.FullName);
            testItem.SetMetadata("AssemblyPath", TestAssemblyPath);
            testItem.SetMetadata("IsAot", aotTestAttr != null ? "true" : "false");
            testItem.SetMetadata("IsTrim", trimTestAttr != null ? "true" : "false");
            testItem.SetMetadata("RuntimeIdentifier", runtimeIdentifier);
            testItem.SetMetadata("TrimMode", trimMode);
            testItem.SetMetadata("Configuration", configuration);
            testItem.SetMetadata("TimeoutSeconds", timeoutSeconds.ToString());
            testItem.SetMetadata("IsStatic", method.IsStatic ? "true" : "false");

            // Store disabled switches as semicolon-separated string
            if (disabledSwitches != null && disabledSwitches.Length > 0)
            {
                testItem.SetMetadata("DisabledFeatureSwitches", string.Join(";", disabledSwitches));
            }

            discoveredTests.Add(testItem);

            Log.LogMessage(MessageImportance.Normal,
                $"Discovered {(aotTestAttr != null ? "AOT" : "Trim")} test: {type.FullName}.{method.Name}");
        }
    }

    DiscoveredTests = discoveredTests.ToArray();
    Log.LogMessage(MessageImportance.High, $"Discovered {discoveredTests.Count} AOT/Trim tests");
}
catch (Exception ex)
{
    Log.LogError($"Error discovering AOT tests: {ex.Message}");
    Log.LogMessage(MessageImportance.Normal, ex.ToString());
    return false;
}

return true;
]]>
      </Code>
    </Task>
  </UsingTask>

  <!-- ================================================================
       DISCOVERY TARGET
       Runs BEFORE VSTest to discover AOT/Trim tests
       ================================================================ -->

  <Target Name="_DiscoverAotTests"
          BeforeTargets="VSTest"
          Condition="'$(EnableAotTesting)' == 'true'">

    <Message Text="[AOT Testing] Discovering AOT/Trim tests in $(_TestAssemblyPath)"
             Importance="High" />

    <!-- Run the discovery task -->
    <DiscoverAotTestsTask TestAssemblyPath="$(_TestAssemblyPath)"
                          DefaultRuntimeIdentifier="$(_DefaultRuntimeIdentifier)"
                          CurrentOsName="$(_CurrentOsName)">
      <Output TaskParameter="DiscoveredTests" ItemName="AotTestItem" />
    </DiscoverAotTestsTask>

    <!-- Create project metadata for each test (two-phase to handle dependencies) -->
    <!-- Phase 1: Set base paths -->
    <ItemGroup>
      <AotTestItem>
        <ProjectDir>$([MSBuild]::NormalizeDirectory('$(AotTestProjectsDir)', '%(Identity)'))</ProjectDir>
        <ExecutableName Condition="'$(_CurrentOsName)' == 'win'">project.exe</ExecutableName>
        <ExecutableName Condition="'$(_CurrentOsName)' != 'win'">project</ExecutableName>
      </AotTestItem>
    </ItemGroup>

    <!-- Phase 2: Set derived paths (depends on ProjectDir) -->
    <ItemGroup>
      <AotTestItem>
        <ProjectFile>%(ProjectDir)project.csproj</ProjectFile>
        <ProgramFile>%(ProjectDir)Program.cs</ProgramFile>
        <DirBuildProps>%(ProjectDir)Directory.Build.props</DirBuildProps>
        <PublishDir>%(ProjectDir)bin\%(Configuration)\$(TargetFramework)\%(RuntimeIdentifier)\publish\</PublishDir>
      </AotTestItem>
    </ItemGroup>

    <!-- Phase 3: Set executable path (depends on PublishDir) -->
    <ItemGroup>
      <AotTestItem>
        <ExecutablePath>%(PublishDir)%(ExecutableName)</ExecutablePath>
      </AotTestItem>
    </ItemGroup>

  </Target>

  <!-- ================================================================
       PROJECT GENERATION TARGET
       Creates temporary project files for each test
       ================================================================ -->

  <Target Name="_GenerateAotTestProjects"
          DependsOnTargets="_DiscoverAotTests"
          Inputs="$(_TestAssemblyPath)"
          Outputs="%(AotTestItem.ProjectFile)"
          Condition="'$(EnableAotTesting)' == 'true' and '@(AotTestItem)' != ''">

    <PropertyGroup>
      <_CurrentTestId>%(AotTestItem.Identity)</_CurrentTestId>
      <_CurrentProjectDir>%(AotTestItem.ProjectDir)</_CurrentProjectDir>
      <_CurrentProjectFile>%(AotTestItem.ProjectFile)</_CurrentProjectFile>
      <_CurrentProgramFile>%(AotTestItem.ProgramFile)</_CurrentProgramFile>
      <_CurrentDirBuildProps>%(AotTestItem.DirBuildProps)</_CurrentDirBuildProps>
      <_CurrentMethodName>%(AotTestItem.MethodName)</_CurrentMethodName>
      <_CurrentTypeName>%(AotTestItem.TypeName)</_CurrentTypeName>
      <_CurrentIsStatic>%(AotTestItem.IsStatic)</_CurrentIsStatic>
      <_CurrentRuntimeIdentifier>%(AotTestItem.RuntimeIdentifier)</_CurrentRuntimeIdentifier>
      <_CurrentConfiguration>%(AotTestItem.Configuration)</_CurrentConfiguration>
      <_CurrentIsAot>%(AotTestItem.IsAot)</_CurrentIsAot>
      <_CurrentIsTrim>%(AotTestItem.IsTrim)</_CurrentIsTrim>
      <_CurrentTrimMode>%(AotTestItem.TrimMode)</_CurrentTrimMode>
      <_CurrentDisabledSwitches>%(AotTestItem.DisabledFeatureSwitches)</_CurrentDisabledSwitches>
    </PropertyGroup>

    <Message Text="[AOT Testing] Generating project for $(_CurrentTestId): $(_CurrentTypeName).$(_CurrentMethodName)"
             Importance="Normal" />

    <!-- Create project directory -->
    <MakeDir Directories="$(_CurrentProjectDir)" />

    <!-- Prepare RuntimeHostConfigurationOptions -->
    <ItemGroup>
      <_CurrentSwitchItem Include="$(_CurrentDisabledSwitches.Split(';'))" Condition="'$(_CurrentDisabledSwitches)' != ''" />
      <_RuntimeHostConfigOptions Include="@(_CurrentSwitchItem->'&lt;RuntimeHostConfigurationOption Include=&quot;%(Identity)&quot; Value=&quot;false&quot; Trim=&quot;true&quot; /&gt;', '%0a    ')" />
    </ItemGroup>

    <PropertyGroup>
      <_RuntimeHostConfigOptionsString>@(_RuntimeHostConfigOptions)</_RuntimeHostConfigOptionsString>
      <!-- Generate AOT/Trim properties based on test type -->
      <!-- AOT tests: PublishAot=true (trimming is implied, don't set PublishTrimmed=false) -->
      <!-- Trim tests: PublishTrimmed=true with TrimMode -->
      <_AotPropertiesString Condition="'$(_CurrentIsAot)' == 'true'">&lt;PublishAot&gt;true&lt;/PublishAot&gt;%0a    &lt;TrimMode&gt;$(_CurrentTrimMode)&lt;/TrimMode&gt;</_AotPropertiesString>
      <_AotPropertiesString Condition="'$(_CurrentIsTrim)' == 'true' and '$(_CurrentIsAot)' != 'true'">&lt;PublishTrimmed&gt;true&lt;/PublishTrimmed&gt;%0a    &lt;TrimMode&gt;$(_CurrentTrimMode)&lt;/TrimMode&gt;</_AotPropertiesString>
    </PropertyGroup>

    <!-- Generate project file from template -->
    <WriteLinesToFile File="$(_CurrentProjectFile)"
                      Lines="$([System.IO.File]::ReadAllText('$(_AotTestProjectTemplate)')
                                                 .Replace('{TargetFramework}', '$(TargetFramework)')
                                                 .Replace('{RuntimeIdentifier}', '$(_CurrentRuntimeIdentifier)')
                                                 .Replace('{Configuration}', '$(_CurrentConfiguration)')
                                                 .Replace('{AotProperties}', '    $(_AotPropertiesString)')
                                                 .Replace('{RuntimeHostConfigurationOptions}', '$(_RuntimeHostConfigOptionsString)')
                                                 .Replace('{ProjectReferences}', '&lt;Reference Include=&quot;$(_TestAssemblyPath)&quot; /&gt;')
                                                 )"
                      Overwrite="true" />

    <!-- Generate Directory.Build.props -->
    <Copy SourceFiles="$(_AotTestDirBuildProps)"
          DestinationFiles="$(_CurrentDirBuildProps)"
          SkipUnchangedFiles="false" />

    <!-- Generate Program.cs -->
    <PropertyGroup>
      <_ProgramCsContent Condition="'$(_CurrentIsStatic)' == 'true'">
using System%3b

public class Program
{
    public static int Main()
    {
        try
        {
            return $(_CurrentTypeName).$(_CurrentMethodName)()%3b
        }
        catch (System.Exception ex)
        {
            System.Console.WriteLine($"Test failed with exception: {ex}")%3b
            return 1%3b
        }
    }
}
      </_ProgramCsContent>
      <_ProgramCsContent Condition="'$(_CurrentIsStatic)' != 'true'">
using System%3b

public class Program
{
    public static int Main()
    {
        try
        {
            var instance = new $(_CurrentTypeName)()%3b
            return instance.$(_CurrentMethodName)()%3b
        }
        catch (System.Exception ex)
        {
            System.Console.WriteLine($"Test failed with exception: {ex}")%3b
            return 1%3b
        }
    }
}
      </_ProgramCsContent>
    </PropertyGroup>

    <WriteLinesToFile File="$(_CurrentProgramFile)"
                      Lines="$(_ProgramCsContent)"
                      Overwrite="true" />

    <Message Text="[AOT Testing] Generated project: $(_CurrentProjectFile)"
             Importance="Normal" />

    <ItemGroup>
      <_CurrentSwitchItem Remove="@(_CurrentSwitchItem)" />
      <_RuntimeHostConfigOptions Remove="@(_RuntimeHostConfigOptions)" />
    </ItemGroup>

  </Target>

  <!-- ================================================================
       PUBLISH TARGET
       Publishes each AOT test project
       ================================================================ -->

  <Target Name="_PublishAotTests"
          DependsOnTargets="_GenerateAotTestProjects"
          Condition="'$(EnableAotTesting)' == 'true' and '@(AotTestItem)' != ''">

    <Message Text="[AOT Testing] Publishing AOT test projects..."
             Importance="High" />

    <!-- Restore projects -->
    <MSBuild Projects="@(AotTestItem->'%(ProjectFile)')"
             Targets="Restore"
             Properties="Configuration=%(Configuration);RuntimeIdentifier=%(RuntimeIdentifier)"
             Condition="'$(SkipAotTestRestore)' != 'true'"
             ContinueOnError="ErrorAndContinue">
      <Output TaskParameter="TargetOutputs" ItemName="_RestoredProjects" />
    </MSBuild>

    <!-- Publish projects -->
    <MSBuild Projects="@(AotTestItem->'%(ProjectFile)')"
             Targets="Publish"
             Properties="Configuration=%(Configuration);RuntimeIdentifier=%(RuntimeIdentifier)"
             ContinueOnError="ErrorAndContinue">
      <Output TaskParameter="TargetOutputs" ItemName="_PublishedProjects" />
    </MSBuild>

  </Target>

  <!-- ================================================================
       EXECUTION TARGET
       Executes each published AOT test
       ================================================================ -->

  <Target Name="_ExecuteAotTests"
          DependsOnTargets="_PublishAotTests"
          Inputs="%(AotTestItem.ProjectFile)"
          Outputs="_unused"
          Condition="'$(EnableAotTesting)' == 'true' and '@(AotTestItem)' != ''">

    <PropertyGroup>
      <_TestExecutable>%(AotTestItem.ExecutablePath)</_TestExecutable>
      <_TestId>%(AotTestItem.Identity)</_TestId>
      <_TestMethodName>%(AotTestItem.MethodName)</_TestMethodName>
      <_TestTypeName>%(AotTestItem.TypeName)</_TestTypeName>
      <_TestTimeoutRaw>%(AotTestItem.TimeoutSeconds)</_TestTimeoutRaw>
      <_TestTimeout Condition="'$(_TestTimeoutRaw)' != ''">$(_TestTimeoutRaw)</_TestTimeout>
      <_TestTimeout Condition="'$(_TestTimeoutRaw)' == ''">300</_TestTimeout>
      <_TestWorkingDir>%(AotTestItem.PublishDir)</_TestWorkingDir>
    </PropertyGroup>

    <Message Text="[AOT Testing] Running test: $(_TestTypeName).$(_TestMethodName)"
             Importance="High" />

    <!-- Execute the test (timeout in milliseconds = seconds * 1000) -->
    <Exec Command="&quot;$(_TestExecutable)&quot;"
          WorkingDirectory="$(_TestWorkingDir)"
          IgnoreExitCode="true"
          Timeout="$([MSBuild]::Multiply($(_TestTimeout), 1000))"
          StandardOutputImportance="Normal"
          StandardErrorImportance="Normal"
          Condition="Exists('$(_TestExecutable)')">
      <Output TaskParameter="ExitCode" PropertyName="_TestExitCode" />
    </Exec>

    <!-- Check if executable exists -->
    <Error Condition="!Exists('$(_TestExecutable)')"
           Text="[AOT Testing] Test executable not found: $(_TestExecutable)"
           ContinueOnError="ErrorAndContinue" />

    <!-- Validate exit code -->
    <PropertyGroup>
      <_TestPassed Condition="'$(_TestExitCode)' == '100'">true</_TestPassed>
      <_TestPassed Condition="'$(_TestExitCode)' != '100'">false</_TestPassed>
    </PropertyGroup>

    <Message Text="[AOT Testing] PASSED: $(_TestTypeName).$(_TestMethodName)"
             Importance="High"
             Condition="'$(_TestPassed)' == 'true'" />

    <Error Text="[AOT Testing] FAILED: $(_TestTypeName).$(_TestMethodName) - Expected exit code 100, got $(_TestExitCode)"
           Condition="'$(_TestPassed)' == 'false' and Exists('$(_TestExecutable)')"
           ContinueOnError="ErrorAndContinue" />

    <!-- Track results -->
    <ItemGroup>
      <_AotTestResult Include="$(_TestId)">
        <Passed>$(_TestPassed)</Passed>
        <ExitCode>$(_TestExitCode)</ExitCode>
        <TestName>$(_TestTypeName).$(_TestMethodName)</TestName>
      </_AotTestResult>
    </ItemGroup>

  </Target>

  <!-- ================================================================
       REPORTING TARGET
       Aggregates and reports test results
       ================================================================ -->

  <Target Name="_ReportAotTestResults"
          DependsOnTargets="_ExecuteAotTests"
          Condition="'$(EnableAotTesting)' == 'true' and '@(AotTestItem)' != ''">

    <PropertyGroup>
      <_TotalTests>@(AotTestItem->Count())</_TotalTests>
      <_PassedTests>@(_AotTestResult->WithMetadataValue('Passed', 'true')->Count())</_PassedTests>
      <_FailedTests>@(_AotTestResult->WithMetadataValue('Passed', 'false')->Count())</_FailedTests>
    </PropertyGroup>

    <Message Text="[AOT Testing] ========================================"
             Importance="High" />
    <Message Text="[AOT Testing] Test Results Summary"
             Importance="High" />
    <Message Text="[AOT Testing] Total:  $(_TotalTests)"
             Importance="High" />
    <Message Text="[AOT Testing] Passed: $(_PassedTests)"
             Importance="High" />
    <Message Text="[AOT Testing] Failed: $(_FailedTests)"
             Importance="High" />
    <Message Text="[AOT Testing] ========================================"
             Importance="High" />

    <!-- Fail if any tests failed -->
    <Error Text="[AOT Testing] $(_FailedTests) test(s) failed. See above for details."
           Condition="'$(_FailedTests)' != '0'" />

  </Target>

  <!-- ================================================================
       MAIN ORCHESTRATION TARGET
       Chains all AOT testing steps together
       ================================================================ -->

  <Target Name="_RunAotTests"
          AfterTargets="VSTest"
          DependsOnTargets="_DiscoverAotTests;_GenerateAotTestProjects;_PublishAotTests;_ExecuteAotTests;_ReportAotTestResults"
          Condition="'$(EnableAotTesting)' == 'true'">

    <Message Text="[AOT Testing] AOT/Trim testing completed."
             Importance="High"
             Condition="'@(AotTestItem)' != ''" />

    <Message Text="[AOT Testing] No AOT/Trim tests discovered."
             Importance="Normal"
             Condition="'@(AotTestItem)' == ''" />

  </Target>

  <!-- ================================================================
       CLEANUP TARGET
       Runs AFTER Clean to remove temporary AOT test artifacts
       ================================================================ -->

  <Target Name="_CleanAotTests"
          AfterTargets="Clean"
          Condition="'$(EnableAotTesting)' == 'true'">

    <RemoveDir Directories="$(AotTestProjectsDir)" />

    <Message Text="[AOT Testing] Cleaned up AOT/Trim test artifacts from $(AotTestProjectsDir)"
             Importance="Normal" />

  </Target>

</Project>
