<Project>
  <!-- Detect test project -->
  <PropertyGroup>
    <IsTestProject Condition="'$(IsTestProject)' == '' and
      ($(MSBuildProjectName.EndsWith('.Tests')) or
       $(MSBuildProjectName.EndsWith('.Test')) or
       $(MSBuildProjectDirectory.Contains('tests')))">true
    </IsTestProject>
  </PropertyGroup>

  <!-- Detect integration test project (directory-based, evaluated at property time) -->
  <PropertyGroup>
    <IsIntegrationTestProject Condition="'$(IsIntegrationTestProject)' == '' and
      ($(MSBuildProjectDirectory.Contains('Integration')) or
       $(MSBuildProjectDirectory.Contains('E2E')))">true
    </IsIntegrationTestProject>
  </PropertyGroup>

  <!-- Detect analyzer test project (name or reference-based) -->
  <PropertyGroup>
    <IsAnalyzerTestProject Condition="'$(IsAnalyzerTestProject)' == '' and
      ($(MSBuildProjectName.Contains('Analyzers')) or
       $(MSBuildProjectName.Contains('Analyzer')))">true
    </IsAnalyzerTestProject>
  </PropertyGroup>

  <!-- Test project configuration -->
  <PropertyGroup Condition="'$(IsTestProject)' == 'true'">
    <OutputType>Exe</OutputType>
    <TestingPlatformDotnetTestSupport>true</TestingPlatformDotnetTestSupport>
    <UseMicrosoftTestingPlatformRunner>true</UseMicrosoftTestingPlatformRunner>
    <UseMicrosoftTestingPlatform>true</UseMicrosoftTestingPlatform>
    <!-- xunit.v3.mtp uses native TRX option (auto-injected by this SDK) -->
    <TestingPlatformCommandLineArguments Condition="'$(TestingPlatformCommandLineArguments)' == '' and '$(SkipXunitInjection)' != 'true'">--report-xunit-trx</TestingPlatformCommandLineArguments>
  </PropertyGroup>

  <!-- Integration test configuration -->
  <PropertyGroup Condition="'$(IsIntegrationTestProject)' == 'true'">
    <NoDefaultLaunchSettingsFile>true</NoDefaultLaunchSettingsFile>
    <WarningsAsErrors>$(WarningsAsErrors);ASP0027</WarningsAsErrors>
  </PropertyGroup>

  <!-- Auto-inject xunit packages (set SkipXunitInjection=true if using TUnit/NUnit/MSTest) -->
  <ItemGroup Condition="'$(IsTestProject)' == 'true' and '$(TargetFrameworkIdentifier)' != '.NETStandard' and '$(SkipXunitInjection)' != 'true'">
    <PackageReference Include="xunit.v3.mtp-v2" Version="$(XunitMtpVersion)" VersionOverride="$(XunitMtpVersion)" IsImplicitlyDefined="false"/>
    <PackageReference Include="Meziantou.Xunit.v3.ParallelTestFramework" Version="$(ParallelTestFrameworkVersion)" VersionOverride="$(ParallelTestFrameworkVersion)" IsImplicitlyDefined="false"/>
  </ItemGroup>

  <!-- AwesomeAssertions is useful for any test framework -->
  <ItemGroup Condition="'$(IsTestProject)' == 'true' and '$(TargetFrameworkIdentifier)' != '.NETStandard'">
    <PackageReference Include="AwesomeAssertions" Version="$(AwesomeAssertionsVersion)" VersionOverride="$(AwesomeAssertionsVersion)" IsImplicitlyDefined="false"/>
    <PackageReference Include="AwesomeAssertions.Analyzers" Version="$(AwesomeAssertionsAnalyzersVersion)" VersionOverride="$(AwesomeAssertionsAnalyzersVersion)" IsImplicitlyDefined="false">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    </PackageReference>
    <!-- Microsoft.Extensions.Diagnostics.Testing is injected by Tests.targets -->
  </ItemGroup>

  <!-- Auto-inject integration test packages -->
  <ItemGroup Condition="'$(IsIntegrationTestProject)' == 'true'">
    <PackageReference Include="Microsoft.AspNetCore.Mvc.Testing" Version="$(MvcTestingVersion)" VersionOverride="$(MvcTestingVersion)"/>
  </ItemGroup>

  <!-- Auto-inject integration test base classes (only for integration test projects) -->
  <ItemGroup Condition="'$(IsIntegrationTestProject)' == 'true'">
    <Compile Include="$(MSBuildThisFileDirectory)../Shared/IntegrationTestBase.cs" Link="__Generated__/IntegrationTestBase.cs" Visible="false"/>
    <Compile Include="$(MSBuildThisFileDirectory)../Shared/KestrelTestBase.cs" Link="__Generated__/KestrelTestBase.cs" Visible="false"/>
    <Compile Include="$(MSBuildThisFileDirectory)../Shared/FakeLoggerExtensions.cs" Link="__Generated__/FakeLoggerExtensions.cs" Visible="false"/>
  </ItemGroup>

  <!-- Auto-inject analyzer test packages -->
  <ItemGroup Condition="'$(IsAnalyzerTestProject)' == 'true' and '$(TargetFrameworkIdentifier)' != '.NETStandard'">
    <PackageReference Include="Microsoft.CodeAnalysis.CSharp.Analyzer.Testing" Version="$(AnalyzerTestingVersion)" VersionOverride="$(AnalyzerTestingVersion)"/>
    <PackageReference Include="Microsoft.CodeAnalysis.CSharp.CodeFix.Testing" Version="$(AnalyzerTestingVersion)" VersionOverride="$(AnalyzerTestingVersion)"/>
    <PackageReference Include="Basic.Reference.Assemblies.Net100" Version="$(BasicReferenceAssembliesVersion)" VersionOverride="$(BasicReferenceAssembliesVersion)"/>
    <PackageReference Include="Basic.Reference.Assemblies.NetStandard20" Version="$(BasicReferenceAssembliesVersion)" VersionOverride="$(BasicReferenceAssembliesVersion)"/>
  </ItemGroup>

  <!-- Auto-inject analyzer test base classes (set InjectAnalyzerTestFixtures=false to disable) -->
  <ItemGroup Condition="'$(IsAnalyzerTestProject)' == 'true' and '$(InjectAnalyzerTestFixtures)' != 'false'">
    <Compile Include="$(MSBuildThisFileDirectory)../Shared/AnalyzerTest.cs" Link="__Generated__/AnalyzerTest.cs" Visible="false"/>
    <Compile Include="$(MSBuildThisFileDirectory)../Shared/CodeFixTest.cs" Link="__Generated__/CodeFixTest.cs" Visible="false"/>
    <Compile Include="$(MSBuildThisFileDirectory)../Shared/CodeFixTestWithEditorConfig.cs" Link="__Generated__/CodeFixTestWithEditorConfig.cs" Visible="false"/>
  </ItemGroup>

  <!-- Auto-inject GlobalUsings for tests (AwesomeAssertions works with any framework) -->
  <ItemGroup Condition="'$(IsTestProject)' == 'true' and '$(ImplicitUsings)' == 'enable'">
    <Using Include="AwesomeAssertions"/>
  </ItemGroup>

  <!-- Only inject Xunit global using when not skipped (TUnit/NUnit/MSTest users set SkipXunitInjection=true) -->
  <ItemGroup Condition="'$(IsTestProject)' == 'true' and '$(ImplicitUsings)' == 'enable' and '$(SkipXunitInjection)' != 'true'">
    <Using Include="Xunit"/>
  </ItemGroup>

  <!-- Auto-inject GlobalUsings for integration tests (includes ASP.NET Core packages) -->
  <ItemGroup Condition="'$(IsIntegrationTestProject)' == 'true' and '$(ImplicitUsings)' == 'enable'">
    <Using Include="System.Net.Http.Json"/>
    <Using Include="Microsoft.Extensions.DependencyInjection"/>
    <Using Include="Microsoft.Extensions.DependencyInjection.Extensions"/>
    <Using Include="Microsoft.AspNetCore.Mvc.Testing"/>
    <Using Include="Microsoft.AspNetCore.TestHost"/>
    <Using Include="Microsoft.AspNetCore.Hosting"/>
  </ItemGroup>

  <!--
    Target-based integration test detection (runs at target time when items are resolved)
    Detects projects that reference .Web or .Api projects
  -->
  <Target Name="_AncpLuaDetectIntegrationTestReferences" BeforeTargets="BeforeBuild;ResolveProjectReferences">
    <ItemGroup>
      <_WebApiRefs Include="@(ProjectReference)" Condition="$([System.String]::new('%(Identity)').EndsWith('.Web.csproj')) or $([System.String]::new('%(Identity)').EndsWith('.Api.csproj'))"/>
    </ItemGroup>

    <PropertyGroup Condition="'@(_WebApiRefs)' != '' and '$(IsIntegrationTestProject)' != 'true'">
      <IsIntegrationTestProject>true</IsIntegrationTestProject>
    </PropertyGroup>
  </Target>

</Project>