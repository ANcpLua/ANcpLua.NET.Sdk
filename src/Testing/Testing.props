<Project>
  <!-- Detect test project -->
  <PropertyGroup>
    <IsTestProject Condition="'$(IsTestProject)' == '' and
      ($(MSBuildProjectName.EndsWith('.Tests')) or
       $(MSBuildProjectName.EndsWith('.Test')) or
       $(MSBuildProjectDirectory.Contains('tests')))">true
    </IsTestProject>
  </PropertyGroup>

  <!-- Detect integration test project (directory-based, evaluated at property time) -->
  <PropertyGroup>
    <IsIntegrationTestProject Condition="'$(IsIntegrationTestProject)' == '' and
      ($(MSBuildProjectDirectory.Contains('Integration')) or
       $(MSBuildProjectDirectory.Contains('E2E')))">true
    </IsIntegrationTestProject>
  </PropertyGroup>

  <!-- Detect analyzer test project (name or reference-based) -->
  <PropertyGroup>
    <IsAnalyzerTestProject Condition="'$(IsAnalyzerTestProject)' == '' and
      ($(MSBuildProjectName.Contains('Analyzers')) or
       $(MSBuildProjectName.Contains('Analyzer')))">true
    </IsAnalyzerTestProject>
  </PropertyGroup>

  <!-- Test project configuration -->
  <PropertyGroup Condition="'$(IsTestProject)' == 'true'">
    <OutputType>Exe</OutputType>
    <TestingPlatformDotnetTestSupport>true</TestingPlatformDotnetTestSupport>
    <UseMicrosoftTestingPlatformRunner>true</UseMicrosoftTestingPlatformRunner>
    <UseMicrosoftTestingPlatform>true</UseMicrosoftTestingPlatform>
    <!-- xunit.v3.mtp uses native TRX option (auto-injected by this SDK) -->
    <TestingPlatformCommandLineArguments Condition="'$(TestingPlatformCommandLineArguments)' == '' and '$(SkipXunitInjection)' != 'true'">--report-xunit-trx</TestingPlatformCommandLineArguments>
  </PropertyGroup>

  <!-- Integration test configuration -->
  <PropertyGroup Condition="'$(IsIntegrationTestProject)' == 'true'">
    <NoDefaultLaunchSettingsFile>true</NoDefaultLaunchSettingsFile>
    <WarningsAsErrors>$(WarningsAsErrors);ASP0027</WarningsAsErrors>
  </PropertyGroup>

  <!-- Auto-inject xunit packages (set SkipXunitInjection=true if using TUnit/NUnit/MSTest) -->
  <ItemGroup Condition="'$(IsTestProject)' == 'true' and '$(TargetFrameworkIdentifier)' != '.NETStandard' and '$(SkipXunitInjection)' != 'true'">
    <PackageReference Include="xunit.v3.mtp-v2" Version="$(XunitMtpVersion)" VersionOverride="$(XunitMtpVersion)" IsImplicitlyDefined="false"/>
    <PackageReference Include="Meziantou.Xunit.v3.ParallelTestFramework" Version="$(ParallelTestFrameworkVersion)" VersionOverride="$(ParallelTestFrameworkVersion)" IsImplicitlyDefined="false"/>
  </ItemGroup>

  <!-- AwesomeAssertions is useful for any test framework -->
  <!-- Note: AwesomeAssertions.Analyzers is injected via GlobalPackages.props (not here) to avoid NETSDK1023 -->
  <ItemGroup Condition="'$(IsTestProject)' == 'true' and '$(TargetFrameworkIdentifier)' != '.NETStandard'">
    <PackageReference Include="AwesomeAssertions" Version="$(AwesomeAssertionsVersion)" VersionOverride="$(AwesomeAssertionsVersion)" IsImplicitlyDefined="true"/>
    <!-- Microsoft.Extensions.Diagnostics.Testing is injected by Tests.targets -->
  </ItemGroup>

  <!-- Auto-inject integration test packages -->
  <ItemGroup Condition="'$(IsIntegrationTestProject)' == 'true'">
    <PackageReference Include="Microsoft.AspNetCore.Mvc.Testing" Version="$(MvcTestingVersion)" VersionOverride="$(MvcTestingVersion)"/>
  </ItemGroup>

  <!-- Auto-inject integration test base classes (set InjectIntegrationTestFixtures=false to disable) -->
  <ItemGroup Condition="'$(IsIntegrationTestProject)' == 'true' and '$(InjectIntegrationTestFixtures)' != 'false'">
    <Compile Include="$(MSBuildThisFileDirectory)../Testing/Fixtures/IntegrationTestBase.cs" Link="__Generated__/IntegrationTestBase.cs" Visible="false"/>
    <Compile Include="$(MSBuildThisFileDirectory)../Testing/Fixtures/KestrelTestBase.cs" Link="__Generated__/KestrelTestBase.cs" Visible="false"/>
    <Compile Include="$(MSBuildThisFileDirectory)../Testing/Fixtures/FakeLoggerExtensions.cs" Link="__Generated__/FakeLoggerExtensions.cs" Visible="false"/>
  </ItemGroup>

  <!-- Opt-in: Roslyn analyzer/generator test infrastructure
       Enable with: <UseRoslynUtilitiesTesting>true</UseRoslynUtilitiesTesting>

       ANcpLua.Roslyn.Utilities.Testing provides:
       - Microsoft.CodeAnalysis.CSharp.Analyzer.Testing
       - Microsoft.CodeAnalysis.CSharp.CodeFix.Testing
       - Microsoft.CodeAnalysis.CSharp.SourceGenerators.Testing
       - Basic.Reference.Assemblies.Net100/NetStandard20
       - AwesomeAssertions
       - Test<TGenerator>, AnalyzerTest<T>, CodeFixTest<T,T>, ProjectBuilder APIs -->
  <ItemGroup Condition="'$(UseRoslynUtilitiesTesting)' == 'true' and '$(TargetFrameworkIdentifier)' != '.NETStandard'">
    <PackageReference Include="ANcpLua.Roslyn.Utilities.Testing" Version="$(ANcpLuaRoslynUtilitiesTestingVersion)" VersionOverride="$(ANcpLuaRoslynUtilitiesTestingVersion)"/>
  </ItemGroup>

  <!-- Auto-inject GlobalUsings for tests (AwesomeAssertions works with any framework) -->
  <ItemGroup Condition="'$(IsTestProject)' == 'true' and '$(ImplicitUsings)' == 'enable'">
    <Using Include="AwesomeAssertions"/>
  </ItemGroup>

  <!-- Only inject Xunit global using when not skipped (TUnit/NUnit/MSTest users set SkipXunitInjection=true) -->
  <ItemGroup Condition="'$(IsTestProject)' == 'true' and '$(ImplicitUsings)' == 'enable' and '$(SkipXunitInjection)' != 'true'">
    <Using Include="Xunit"/>
  </ItemGroup>

  <!-- Auto-inject GlobalUsings for integration tests (includes ASP.NET Core packages) -->
  <ItemGroup Condition="'$(IsIntegrationTestProject)' == 'true' and '$(ImplicitUsings)' == 'enable'">
    <Using Include="System.Net.Http.Json"/>
    <Using Include="Microsoft.Extensions.DependencyInjection"/>
    <Using Include="Microsoft.Extensions.DependencyInjection.Extensions"/>
    <Using Include="Microsoft.AspNetCore.Mvc.Testing"/>
    <Using Include="Microsoft.AspNetCore.TestHost"/>
    <Using Include="Microsoft.AspNetCore.Hosting"/>
  </ItemGroup>

  <!-- GlobalUsings for Roslyn utilities testing (when opted-in) -->
  <ItemGroup Condition="'$(UseRoslynUtilitiesTesting)' == 'true' and '$(ImplicitUsings)' == 'enable'">
    <Using Include="ANcpLua.Roslyn.Utilities.Testing"/>
    <Using Include="Microsoft.CodeAnalysis"/>
    <Using Include="Microsoft.CodeAnalysis.CSharp"/>
    <Using Include="Microsoft.CodeAnalysis.Diagnostics"/>
  </ItemGroup>

  <!--
    Target-based integration test detection (runs at target time when items are resolved)
    Detects projects that reference .Web or .Api projects
  -->
  <Target Name="_AncpLuaDetectIntegrationTestReferences" BeforeTargets="BeforeBuild;ResolveProjectReferences">
    <ItemGroup>
      <_WebApiRefs Include="@(ProjectReference)" Condition="$([System.String]::new('%(Identity)').EndsWith('.Web.csproj')) or $([System.String]::new('%(Identity)').EndsWith('.Api.csproj'))"/>
    </ItemGroup>

    <PropertyGroup Condition="'@(_WebApiRefs)' != '' and '$(IsIntegrationTestProject)' != 'true'">
      <IsIntegrationTestProject>true</IsIntegrationTestProject>
    </PropertyGroup>
  </Target>

  <!-- Import AOT/Trim testing infrastructure -->
  <Import Project="$(MSBuildThisFileDirectory)AotTesting/AotTesting.props" Condition="Exists('$(MSBuildThisFileDirectory)AotTesting/AotTesting.props')" />

</Project>